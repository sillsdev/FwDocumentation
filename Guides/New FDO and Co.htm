<html>

<head>
<meta http-equiv=Content-Type content="text/html; charset=windows-1252">
<meta name=Generator content="Microsoft Word 12 (filtered)">

<style id="dynCom" type="text/css"><!-- --></style>
<script language="JavaScript"><!--
function msoCommentShow(anchor_id, com_id)
{
	if(msoBrowserCheck())
		{
		c = document.all(com_id);
		a = document.all(anchor_id);
		if (null != c && null == c.length && null != a && null == a.length)
			{
			var cw = c.offsetWidth;
			var ch = c.offsetHeight;
			var aw = a.offsetWidth;
			var ah = a.offsetHeight;
			var x  = a.offsetLeft;
			var y  = a.offsetTop;
			var el = a;
			while (el.tagName != "BODY")
				{
				el = el.offsetParent;
				x = x + el.offsetLeft;
				y = y + el.offsetTop;
				}
			var bw = document.body.clientWidth;
			var bh = document.body.clientHeight;
			var bsl = document.body.scrollLeft;
			var bst = document.body.scrollTop;
			if (x + cw + ah / 2 > bw + bsl && x + aw - ah / 2 - cw >= bsl )
				{ c.style.left = x + aw - ah / 2 - cw; }
			else
				{ c.style.left = x + ah / 2; }
			if (y + ch + ah / 2 > bh + bst && y + ah / 2 - ch >= bst )
				{ c.style.top = y + ah / 2 - ch; }
			else
				{ c.style.top = y + ah / 2; }
			c.style.visibility = "visible";
}	}	}
function msoCommentHide(com_id)
{
	if(msoBrowserCheck())
		{
		c = document.all(com_id);
		if (null != c && null == c.length)
		{
		c.style.visibility = "hidden";
		c.style.left = -1000;
		c.style.top = -1000;
		} }
}
function msoBrowserCheck()
{
	ms = navigator.appVersion.indexOf("MSIE");
	vers = navigator.appVersion.substring(ms + 5, ms + 6);
	ie4 = (ms > 0) && (parseInt(vers) >= 4);
	return ie4;
}
if (msoBrowserCheck())
{
	document.styleSheets.dynCom.addRule(".msocomanchor","background: infobackground");
	document.styleSheets.dynCom.addRule(".msocomoff","display: none");
	document.styleSheets.dynCom.addRule(".msocomtxt","visibility: hidden");
	document.styleSheets.dynCom.addRule(".msocomtxt","position: absolute");
	document.styleSheets.dynCom.addRule(".msocomtxt","top: -1000");
	document.styleSheets.dynCom.addRule(".msocomtxt","left: -1000");
	document.styleSheets.dynCom.addRule(".msocomtxt","width: 33%");
	document.styleSheets.dynCom.addRule(".msocomtxt","background: infobackground");
	document.styleSheets.dynCom.addRule(".msocomtxt","color: infotext");
	document.styleSheets.dynCom.addRule(".msocomtxt","border-top: 1pt solid threedlightshadow");
	document.styleSheets.dynCom.addRule(".msocomtxt","border-right: 2pt solid threedshadow");
	document.styleSheets.dynCom.addRule(".msocomtxt","border-bottom: 2pt solid threedshadow");
	document.styleSheets.dynCom.addRule(".msocomtxt","border-left: 1pt solid threedlightshadow");
	document.styleSheets.dynCom.addRule(".msocomtxt","padding: 3pt 3pt 3pt 3pt");
	document.styleSheets.dynCom.addRule(".msocomtxt","z-index: 100");
}
// --></script>
<style>
<!--
 /* Font Definitions */
 @font-face
	{font-family:SimSun;
	panose-1:2 1 6 0 3 1 1 1 1 1;}
@font-face
	{font-family:"Cambria Math";
	panose-1:2 4 5 3 5 4 6 3 2 4;}
@font-face
	{font-family:Cambria;
	panose-1:2 4 5 3 5 4 6 3 2 4;}
@font-face
	{font-family:Calibri;
	panose-1:2 15 5 2 2 2 4 3 2 4;}
@font-face
	{font-family:Tahoma;
	panose-1:2 11 6 4 3 5 4 4 2 4;}
@font-face
	{font-family:Consolas;
	panose-1:2 11 6 9 2 2 4 3 2 4;}
@font-face
	{font-family:"\@SimSun";
	panose-1:2 1 6 0 3 1 1 1 1 1;}
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:10.0pt;
	margin-left:0in;
	line-height:115%;
	font-size:11.0pt;
	font-family:"Calibri","sans-serif";}
h1
	{mso-style-link:"Heading 1 Char";
	margin-top:24.0pt;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:.3in;
	margin-bottom:.0001pt;
	text-indent:-.3in;
	line-height:115%;
	page-break-after:avoid;
	font-size:14.0pt;
	font-family:"Cambria","serif";
	color:#365F91;}
h2
	{mso-style-link:"Heading 2 Char";
	margin-top:10.0pt;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:.4in;
	margin-bottom:.0001pt;
	text-indent:-.4in;
	line-height:115%;
	page-break-after:avoid;
	font-size:13.0pt;
	font-family:"Cambria","serif";
	color:#4F81BD;}
h3
	{mso-style-link:"Heading 3 Char";
	margin-top:10.0pt;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:.5in;
	margin-bottom:.0001pt;
	text-indent:-.5in;
	line-height:115%;
	page-break-after:avoid;
	font-size:11.0pt;
	font-family:"Cambria","serif";
	color:#4F81BD;}
h4
	{mso-style-link:"Heading 4 Char";
	margin-top:10.0pt;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:.6in;
	margin-bottom:.0001pt;
	text-indent:-.6in;
	line-height:115%;
	page-break-after:avoid;
	font-size:11.0pt;
	font-family:"Cambria","serif";
	color:#4F81BD;
	font-style:italic;}
h5
	{mso-style-link:"Heading 5 Char";
	margin-top:10.0pt;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:.7in;
	margin-bottom:.0001pt;
	text-indent:-.7in;
	line-height:115%;
	page-break-after:avoid;
	font-size:11.0pt;
	font-family:"Cambria","serif";
	color:#243F60;
	font-weight:normal;}
h6
	{mso-style-link:"Heading 6 Char";
	margin-top:10.0pt;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:.8in;
	margin-bottom:.0001pt;
	text-indent:-.8in;
	line-height:115%;
	page-break-after:avoid;
	font-size:11.0pt;
	font-family:"Cambria","serif";
	color:#243F60;
	font-weight:normal;
	font-style:italic;}
p.MsoHeading7, li.MsoHeading7, div.MsoHeading7
	{mso-style-link:"Heading 7 Char";
	margin-top:10.0pt;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:.9in;
	margin-bottom:.0001pt;
	text-indent:-.9in;
	line-height:115%;
	page-break-after:avoid;
	font-size:11.0pt;
	font-family:"Cambria","serif";
	color:#404040;
	font-style:italic;}
p.MsoHeading8, li.MsoHeading8, div.MsoHeading8
	{mso-style-link:"Heading 8 Char";
	margin-top:10.0pt;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:1.0in;
	margin-bottom:.0001pt;
	text-indent:-1.0in;
	line-height:115%;
	page-break-after:avoid;
	font-size:10.0pt;
	font-family:"Cambria","serif";
	color:#404040;}
p.MsoHeading9, li.MsoHeading9, div.MsoHeading9
	{mso-style-link:"Heading 9 Char";
	margin-top:10.0pt;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:1.1in;
	margin-bottom:.0001pt;
	text-indent:-1.1in;
	line-height:115%;
	page-break-after:avoid;
	font-size:10.0pt;
	font-family:"Cambria","serif";
	color:#404040;
	font-style:italic;}
p.MsoToc1, li.MsoToc1, div.MsoToc1
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:5.0pt;
	margin-left:0in;
	line-height:115%;
	font-size:11.0pt;
	font-family:"Calibri","sans-serif";}
p.MsoToc2, li.MsoToc2, div.MsoToc2
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:5.0pt;
	margin-left:11.0pt;
	line-height:115%;
	font-size:11.0pt;
	font-family:"Calibri","sans-serif";}
p.MsoToc3, li.MsoToc3, div.MsoToc3
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:5.0pt;
	margin-left:22.0pt;
	line-height:115%;
	font-size:11.0pt;
	font-family:"Calibri","sans-serif";}
p.MsoToc4, li.MsoToc4, div.MsoToc4
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:5.0pt;
	margin-left:33.0pt;
	line-height:115%;
	font-size:11.0pt;
	font-family:"Calibri","sans-serif";}
p.MsoToc5, li.MsoToc5, div.MsoToc5
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:5.0pt;
	margin-left:44.0pt;
	line-height:115%;
	font-size:11.0pt;
	font-family:"Calibri","sans-serif";}
p.MsoToc6, li.MsoToc6, div.MsoToc6
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:5.0pt;
	margin-left:55.0pt;
	line-height:115%;
	font-size:11.0pt;
	font-family:"Calibri","sans-serif";}
p.MsoToc7, li.MsoToc7, div.MsoToc7
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:5.0pt;
	margin-left:66.0pt;
	line-height:115%;
	font-size:11.0pt;
	font-family:"Calibri","sans-serif";}
p.MsoToc8, li.MsoToc8, div.MsoToc8
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:5.0pt;
	margin-left:77.0pt;
	line-height:115%;
	font-size:11.0pt;
	font-family:"Calibri","sans-serif";}
p.MsoToc9, li.MsoToc9, div.MsoToc9
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:5.0pt;
	margin-left:88.0pt;
	line-height:115%;
	font-size:11.0pt;
	font-family:"Calibri","sans-serif";}
p.MsoFootnoteText, li.MsoFootnoteText, div.MsoFootnoteText
	{mso-style-link:"Footnote Text Char";
	margin:0in;
	margin-bottom:.0001pt;
	font-size:10.0pt;
	font-family:"Calibri","sans-serif";}
p.MsoCommentText, li.MsoCommentText, div.MsoCommentText
	{mso-style-link:"Comment Text Char";
	margin-top:0in;
	margin-right:0in;
	margin-bottom:10.0pt;
	margin-left:0in;
	font-size:10.0pt;
	font-family:"Calibri","sans-serif";}
span.MsoFootnoteReference
	{vertical-align:super;}
p.MsoTitle, li.MsoTitle, div.MsoTitle
	{mso-style-link:"Title Char";
	margin-top:0in;
	margin-right:0in;
	margin-bottom:15.0pt;
	margin-left:0in;
	border:none;
	padding:0in;
	font-size:26.0pt;
	font-family:"Cambria","serif";
	color:#17365D;
	letter-spacing:.25pt;}
p.MsoTitleCxSpFirst, li.MsoTitleCxSpFirst, div.MsoTitleCxSpFirst
	{mso-style-link:"Title Char";
	margin:0in;
	margin-bottom:.0001pt;
	border:none;
	padding:0in;
	font-size:26.0pt;
	font-family:"Cambria","serif";
	color:#17365D;
	letter-spacing:.25pt;}
p.MsoTitleCxSpMiddle, li.MsoTitleCxSpMiddle, div.MsoTitleCxSpMiddle
	{mso-style-link:"Title Char";
	margin:0in;
	margin-bottom:.0001pt;
	border:none;
	padding:0in;
	font-size:26.0pt;
	font-family:"Cambria","serif";
	color:#17365D;
	letter-spacing:.25pt;}
p.MsoTitleCxSpLast, li.MsoTitleCxSpLast, div.MsoTitleCxSpLast
	{mso-style-link:"Title Char";
	margin-top:0in;
	margin-right:0in;
	margin-bottom:15.0pt;
	margin-left:0in;
	border:none;
	padding:0in;
	font-size:26.0pt;
	font-family:"Cambria","serif";
	color:#17365D;
	letter-spacing:.25pt;}
a:link, span.MsoHyperlink
	{color:blue;
	text-decoration:underline;}
a:visited, span.MsoHyperlinkFollowed
	{color:purple;
	text-decoration:underline;}
pre
	{mso-style-link:"HTML Preformatted Char";
	margin:0in;
	margin-bottom:.0001pt;
	font-size:10.0pt;
	font-family:"Courier New";
	color:black;}
p.MsoCommentSubject, li.MsoCommentSubject, div.MsoCommentSubject
	{mso-style-link:"Comment Subject Char";
	margin-top:0in;
	margin-right:0in;
	margin-bottom:10.0pt;
	margin-left:0in;
	font-size:10.0pt;
	font-family:"Calibri","sans-serif";
	font-weight:bold;}
p.MsoAcetate, li.MsoAcetate, div.MsoAcetate
	{mso-style-link:"Balloon Text Char";
	margin:0in;
	margin-bottom:.0001pt;
	font-size:8.0pt;
	font-family:"Tahoma","sans-serif";}
p.MsoNoSpacing, li.MsoNoSpacing, div.MsoNoSpacing
	{margin-right:0in;
	margin-left:0in;
	font-size:12.0pt;
	font-family:"Times New Roman","serif";}
p.MsoListParagraph, li.MsoListParagraph, div.MsoListParagraph
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:10.0pt;
	margin-left:.5in;
	line-height:115%;
	font-size:11.0pt;
	font-family:"Calibri","sans-serif";}
p.MsoListParagraphCxSpFirst, li.MsoListParagraphCxSpFirst, div.MsoListParagraphCxSpFirst
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:.5in;
	margin-bottom:.0001pt;
	line-height:115%;
	font-size:11.0pt;
	font-family:"Calibri","sans-serif";}
p.MsoListParagraphCxSpMiddle, li.MsoListParagraphCxSpMiddle, div.MsoListParagraphCxSpMiddle
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:.5in;
	margin-bottom:.0001pt;
	line-height:115%;
	font-size:11.0pt;
	font-family:"Calibri","sans-serif";}
p.MsoListParagraphCxSpLast, li.MsoListParagraphCxSpLast, div.MsoListParagraphCxSpLast
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:10.0pt;
	margin-left:.5in;
	line-height:115%;
	font-size:11.0pt;
	font-family:"Calibri","sans-serif";}
p.MsoTocHeading, li.MsoTocHeading, div.MsoTocHeading
	{margin-top:24.0pt;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:0in;
	margin-bottom:.0001pt;
	line-height:115%;
	page-break-after:avoid;
	font-size:14.0pt;
	font-family:"Cambria","serif";
	color:#365F91;
	font-weight:bold;}
span.Heading1Char
	{mso-style-name:"Heading 1 Char";
	mso-style-link:"Heading 1";
	font-family:"Cambria","serif";
	color:#365F91;
	font-weight:bold;}
span.Heading2Char
	{mso-style-name:"Heading 2 Char";
	mso-style-link:"Heading 2";
	font-family:"Cambria","serif";
	color:#4F81BD;
	font-weight:bold;}
span.Heading3Char
	{mso-style-name:"Heading 3 Char";
	mso-style-link:"Heading 3";
	font-family:"Cambria","serif";
	color:#4F81BD;
	font-weight:bold;}
span.Heading4Char
	{mso-style-name:"Heading 4 Char";
	mso-style-link:"Heading 4";
	font-family:"Cambria","serif";
	color:#4F81BD;
	font-weight:bold;
	font-style:italic;}
span.Heading5Char
	{mso-style-name:"Heading 5 Char";
	mso-style-link:"Heading 5";
	font-family:"Cambria","serif";
	color:#243F60;}
span.Heading6Char
	{mso-style-name:"Heading 6 Char";
	mso-style-link:"Heading 6";
	font-family:"Cambria","serif";
	color:#243F60;
	font-style:italic;}
span.Heading7Char
	{mso-style-name:"Heading 7 Char";
	mso-style-link:"Heading 7";
	font-family:"Cambria","serif";
	color:#404040;
	font-style:italic;}
span.Heading8Char
	{mso-style-name:"Heading 8 Char";
	mso-style-link:"Heading 8";
	font-family:"Cambria","serif";
	color:#404040;}
span.Heading9Char
	{mso-style-name:"Heading 9 Char";
	mso-style-link:"Heading 9";
	font-family:"Cambria","serif";
	color:#404040;
	font-style:italic;}
span.TitleChar
	{mso-style-name:"Title Char";
	mso-style-link:Title;
	font-family:"Cambria","serif";
	color:#17365D;
	letter-spacing:.25pt;}
span.BalloonTextChar
	{mso-style-name:"Balloon Text Char";
	mso-style-link:"Balloon Text";
	font-family:"Tahoma","sans-serif";}
span.FootnoteTextChar
	{mso-style-name:"Footnote Text Char";
	mso-style-link:"Footnote Text";}
span.HTMLPreformattedChar
	{mso-style-name:"HTML Preformatted Char";
	mso-style-link:"HTML Preformatted";
	font-family:"Courier New";
	color:black;}
span.CommentTextChar
	{mso-style-name:"Comment Text Char";
	mso-style-link:"Comment Text";}
span.CommentSubjectChar
	{mso-style-name:"Comment Subject Char";
	mso-style-link:"Comment Subject";
	font-weight:bold;}
p.Code, li.Code, div.Code
	{mso-style-name:Code;
	margin-top:0in;
	margin-right:0in;
	margin-bottom:10.0pt;
	margin-left:.25in;
	line-height:115%;
	font-size:9.0pt;
	font-family:Consolas;}
p.CodeCxSpFirst, li.CodeCxSpFirst, div.CodeCxSpFirst
	{mso-style-name:CodeCxSpFirst;
	margin-top:0in;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:.25in;
	margin-bottom:.0001pt;
	line-height:115%;
	font-size:9.0pt;
	font-family:Consolas;}
p.CodeCxSpMiddle, li.CodeCxSpMiddle, div.CodeCxSpMiddle
	{mso-style-name:CodeCxSpMiddle;
	margin-top:0in;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:.25in;
	margin-bottom:.0001pt;
	line-height:115%;
	font-size:9.0pt;
	font-family:Consolas;}
p.CodeCxSpLast, li.CodeCxSpLast, div.CodeCxSpLast
	{mso-style-name:CodeCxSpLast;
	margin-top:0in;
	margin-right:0in;
	margin-bottom:10.0pt;
	margin-left:.25in;
	line-height:115%;
	font-size:9.0pt;
	font-family:Consolas;}
span.msoIns
	{mso-style-name:"";
	text-decoration:underline;
	color:teal;}
span.msoDel
	{mso-style-name:"";
	text-decoration:line-through;
	color:red;}
.MsoPapDefault
	{margin-bottom:10.0pt;
	line-height:115%;}
 /* Page Definitions */
 @page Section1
	{size:8.5in 11.0in;
	margin:1.0in 1.0in 1.0in 1.0in;}
div.Section1
	{page:Section1;}
 /* List Definitions */
 ol
	{margin-bottom:0in;}
ul
	{margin-bottom:0in;}
-->
</style>

</head>

<body lang=EN-US link=blue vlink=purple>

<div class=Section1>

<div style='border:none;border-bottom:solid #4F81BD 1.0pt;padding:0in 0in 4.0pt 0in'>

<p class=MsoTitle align=center style='text-align:center'>FDO and Related
Infrastructure Systems in Re-architected FieldWorks<a href="#_ftn1"
name="_ftnref1" title=""><span class=MsoFootnoteReference><span
class=MsoFootnoteReference><span style='font-size:26.0pt;line-height:115%;
font-family:"Cambria","serif";color:#17365D;letter-spacing:.25pt'>[1]</span></span></span></a></p>

</div>

<p class=MsoTocHeading>Table of Contents</p>

<p class=MsoToc1><a href="#_Toc238450049">1<span style='color:windowtext;
text-decoration:none'>       </span>General issues and attitudes<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>5</span></a></p>

<p class=MsoToc2><a href="#_Toc238450050">1.1<span style='color:windowtext;
text-decoration:none'>         </span>Code quality should improve<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>5</span></a></p>

<p class=MsoToc2><a href="#_Toc238450051">1.2<span style='color:windowtext;
text-decoration:none'>         </span>Follow the ‘DRY’ principle<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>5</span></a></p>

<p class=MsoToc2><a href="#_Toc238450052">1.3<span style='color:windowtext;
text-decoration:none'>         </span>Unit tests<span style='color:windowtext;
display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>5</span></a></p>

<p class=MsoToc2><a href="#_Toc238450053">1.4<span style='color:windowtext;
text-decoration:none'>         </span>Null object pattern<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>5</span></a></p>

<p class=MsoToc2><a href="#_Toc238450054">1.5<span style='color:windowtext;
text-decoration:none'>         </span>General New Skills<span style='color:
windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>5</span></a></p>

<p class=MsoToc2><a href="#_Toc238450055">1.6<span style='color:windowtext;
text-decoration:none'>         </span>Old code still around<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>6</span></a></p>

<p class=MsoToc2><a href="#_Toc238450056">1.7<span style='color:windowtext;
text-decoration:none'>         </span>Build problems<span style='color:windowtext;
display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>6</span></a></p>

<p class=MsoToc2><a href="#_Toc238450057">1.8<span style='color:windowtext;
text-decoration:none'>         </span>Installing Firebird Server<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>6</span></a></p>

<p class=MsoToc1><a href="#_Toc238450058">2<span style='color:windowtext;
text-decoration:none'>       </span>FDO<span style='color:windowtext;
display:none;text-decoration:none'>.. </span><span
style='color:windowtext;display:none;text-decoration:none'>6</span></a></p>

<p class=MsoToc2><a href="#_Toc238450059">2.1<span style='color:windowtext;
text-decoration:none'>         </span>Interfaces<span style='color:windowtext;
display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>7</span></a></p>

<p class=MsoToc3><a href="#_Toc238450060">2.1.1<span style='color:windowtext;
text-decoration:none'>          </span>CmObject Interfaces<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>7</span></a></p>

<p class=MsoToc3><a href="#_Toc238450061">2.1.2<span style='color:windowtext;
text-decoration:none'>          </span>Factory Interfaces<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>7</span></a></p>

<p class=MsoToc3><a href="#_Toc238450062">2.1.3<span style='color:windowtext;
text-decoration:none'>          </span>Repository Interfaces<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>8</span></a></p>

<p class=MsoToc3><a href="#_Toc238450063">2.1.4<span style='color:windowtext;
text-decoration:none'>          </span>FDO Vector interfaces<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>8</span></a></p>

<p class=MsoToc3><a href="#_Toc238450064">2.1.5<span style='color:windowtext;
text-decoration:none'>          </span>Alternative string and unicode
interfaces<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>8</span></a></p>

<p class=MsoToc3><a href="#_Toc238450065">2.1.6<span style='color:windowtext;
text-decoration:none'>          </span>Internal interfaces<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>9</span></a></p>

<p class=MsoToc2><a href="#_Toc238450066">2.2<span style='color:windowtext;
text-decoration:none'>         </span>Implementations<span style='color:windowtext;
display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>9</span></a></p>

<p class=MsoToc3><a href="#_Toc238450067">2.2.1<span style='color:windowtext;
text-decoration:none'>          </span>CmObject Implementations<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>9</span></a></p>

<p class=MsoToc3><a href="#_Toc238450068">2.2.2<span style='color:windowtext;
text-decoration:none'>          </span>Factory Implementations<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>9</span></a></p>

<p class=MsoToc3><a href="#_Toc238450069">2.2.3<span style='color:windowtext;
text-decoration:none'>          </span>Repository Implementations<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>9</span></a></p>

<p class=MsoToc3><a href="#_Toc238450070">2.2.4<span style='color:windowtext;
text-decoration:none'>          </span>FDO Vector implementations<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>9</span></a></p>

<p class=MsoToc3><a href="#_Toc238450071">2.2.5<span style='color:windowtext;
text-decoration:none'>          </span>FDO MultiString &amp; MultiUnicode
classes<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>9</span></a></p>

<p class=MsoToc2><a href="#_Toc238450072">2.3<span style='color:windowtext;
text-decoration:none'>         </span>Statics on CmObject Implementation
classes<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>9</span></a></p>

<p class=MsoToc2><a href="#_Toc238450073">2.4<span style='color:windowtext;
text-decoration:none'>         </span>FDO &amp; UOW interaction<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>10</span></a></p>

<p class=MsoToc2><a href="#_Toc238450074">2.5<span style='color:windowtext;
text-decoration:none'>         </span>FDO &amp; Persistence Code Interaction<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>10</span></a></p>

<p class=MsoToc2><a href="#_Toc238450075">2.6<span style='color:windowtext;
text-decoration:none'>         </span>FdoCache<span style='color:windowtext;
display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>10</span></a></p>

<p class=MsoToc2><a href="#_Toc238450076">2.7<span style='color:windowtext;
text-decoration:none'>         </span>Service Locator and Dependency Injection<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>10</span></a></p>

<p class=MsoToc2><a href="#_Toc238450077">2.8<span style='color:windowtext;
text-decoration:none'>         </span>HVOs<span style='color:windowtext;
display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>11</span></a></p>

<p class=MsoToc2><a href="#_Toc238450078">2.9<span style='color:windowtext;
text-decoration:none'>         </span>Back references<span style='color:windowtext;
display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>11</span></a></p>

<p class=MsoToc2><a href="#_Toc238450079">2.10<span style='color:windowtext;
text-decoration:none'>      </span>FDO Namespaces<span style='color:windowtext;
display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>12</span></a></p>

<p class=MsoToc3><a href="#_Toc238450080">2.10.1<span style='color:windowtext;
text-decoration:none'>        </span>SIL.FieldWorks.FDO<span style='color:windowtext;
display:none;text-decoration:none'>.. </span><span
style='color:windowtext;display:none;text-decoration:none'>12</span></a></p>

<p class=MsoToc3><a href="#_Toc238450081">2.10.2<span style='color:windowtext;
text-decoration:none'>        </span>SIL.FieldWorks.FDO.Application<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>13</span></a></p>

<p class=MsoToc3><a href="#_Toc238450082">2.10.3<span style='color:windowtext;
text-decoration:none'>        </span>SIL.FieldWorks.FDO.Application.Impl<span
style='color:windowtext;display:none;text-decoration:none'> </span><span
style='color:windowtext;display:none;text-decoration:none'>13</span></a></p>

<p class=MsoToc3><a href="#_Toc238450083">2.10.4<span style='color:windowtext;
text-decoration:none'>        </span>SIL.FieldWorks.FDO.DomainImpl<span
style='color:windowtext;display:none;text-decoration:none'> </span><span
style='color:windowtext;display:none;text-decoration:none'>13</span></a></p>

<p class=MsoToc3><a href="#_Toc238450084">2.10.5<span style='color:windowtext;
text-decoration:none'>        </span>SIL.FieldWorks.FDO.DomainServices<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>13</span></a></p>

<p class=MsoToc3><a href="#_Toc238450085">2.10.6<span style='color:windowtext;
text-decoration:none'>        </span>SIL.FieldWorks.FDO.Infrastructure<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>14</span></a></p>

<p class=MsoToc3><a href="#_Toc238450086">2.10.7<span style='color:windowtext;
text-decoration:none'>        </span>SIL.FieldWorks.FDO.Infrastructure. Impl<span
style='color:windowtext;display:none;text-decoration:none'> </span><span
style='color:windowtext;display:none;text-decoration:none'>14</span></a></p>

<p class=MsoToc1><a href="#_Toc238450087">3<span style='color:windowtext;
text-decoration:none'>       </span>Supporting Infrastructure<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>14</span></a></p>

<p class=MsoToc2><a href="#_Toc238450088">3.1<span style='color:windowtext;
text-decoration:none'>         </span>Persistence<span style='color:windowtext;
display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>14</span></a></p>

<p class=MsoToc3><a href="#_Toc238450089">3.1.1<span style='color:windowtext;
text-decoration:none'>          </span>Creating a new BEP<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>15</span></a></p>

<p class=MsoToc3><a href="#_Toc238450090">3.1.2<span style='color:windowtext;
text-decoration:none'>          </span>Unit Testing a new BEP<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>17</span></a></p>

<p class=MsoToc2><a href="#_Toc238450091">3.2<span style='color:windowtext;
text-decoration:none'>         </span>Unit Of Work<span style='color:windowtext;
display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>19</span></a></p>

<p class=MsoToc2><a href="#_Toc238450092">3.3<span style='color:windowtext;
text-decoration:none'>         </span>IdentityMap<span style='color:windowtext;
display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>21</span></a></p>

<p class=MsoToc2><a href="#_Toc238450093">3.4<span style='color:windowtext;
text-decoration:none'>         </span>Undo/Redo<span style='color:windowtext;
display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>21</span></a></p>

<p class=MsoToc2><a href="#_Toc238450094">3.5<span style='color:windowtext;
text-decoration:none'>         </span>Metadata Cache (IFwMetaDataCacheManaged :
IFwMetaDataCache)<span style='color:windowtext;display:none;text-decoration:
none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>21</span></a></p>

<p class=MsoToc2><a href="#_Toc238450095">3.6<span style='color:windowtext;
text-decoration:none'>         </span>DomainDataByFlid (ISILDataAccessManaged :
ISILDataAccess)<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>21</span></a></p>

<p class=MsoToc2><a href="#_Toc238450096">3.7<span style='color:windowtext;
text-decoration:none'>         </span>Decorators (Metadata cache &amp;
DomainDataByFlid)<span style='color:windowtext;display:none;text-decoration:
none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>22</span></a></p>

<p class=MsoToc2><a href="#_Toc238450097">3.8<span style='color:windowtext;
text-decoration:none'>         </span>Repositories<span style='color:windowtext;
display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>23</span></a></p>

<p class=MsoToc1><a href="#_Toc238450098">4<span style='color:windowtext;
text-decoration:none'>       </span>Upgrading Issues<span style='color:windowtext;
display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>23</span></a></p>

<p class=MsoToc2><a href="#_Toc238450099">4.1<span style='color:windowtext;
text-decoration:none'>         </span>Applications<span style='color:windowtext;
display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>23</span></a></p>

<p class=MsoToc3><a href="#_Toc238450100">4.1.1<span style='color:windowtext;
text-decoration:none'>          </span>Flex<span style='color:windowtext;
display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>24</span></a></p>

<p class=MsoToc3><a href="#_Toc238450101">4.1.2<span style='color:windowtext;
text-decoration:none'>          </span>TE<span style='color:windowtext;
display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>24</span></a></p>

<p class=MsoToc3><a href="#_Toc238450102">4.1.3<span style='color:windowtext;
text-decoration:none'>          </span>Data Notebook<span style='color:windowtext;
display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>24</span></a></p>

<p class=MsoToc3><a href="#_Toc238450103">4.1.4<span style='color:windowtext;
text-decoration:none'>          </span>List Editor<span style='color:windowtext;
display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>24</span></a></p>

<p class=MsoToc2><a href="#_Toc238450104">4.2<span style='color:windowtext;
text-decoration:none'>         </span>Common Upgrade issues<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>24</span></a></p>

<p class=MsoToc3><a href="#_Toc238450105">4.2.1<span style='color:windowtext;
text-decoration:none'>          </span>ISILDataAccess vs. CmObject use<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>24</span></a></p>

<p class=MsoToc2><a href="#_Toc238450106">4.3<span style='color:windowtext;
text-decoration:none'>         </span>FDO code<span style='color:windowtext;
display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>25</span></a></p>

<p class=MsoToc3><a href="#_Toc238450107">4.3.1<span style='color:windowtext;
text-decoration:none'>          </span>Repositories<span style='color:windowtext;
display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>25</span></a></p>

<p class=MsoToc3><a href="#_Toc238450108">4.3.2<span style='color:windowtext;
text-decoration:none'>          </span>Factories<span style='color:windowtext;
display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>25</span></a></p>

<p class=MsoToc3><a href="#_Toc238450109">4.3.3<span style='color:windowtext;
text-decoration:none'>          </span>Obsolete namespaces in FDO<span
style='color:windowtext;display:none;text-decoration:none'>.. </span><span
style='color:windowtext;display:none;text-decoration:none'>25</span></a></p>

<p class=MsoToc3><a href="#_Toc238450110">4.3.4<span style='color:windowtext;
text-decoration:none'>          </span>FdoCache<span style='color:windowtext;
display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>25</span></a></p>

<p class=MsoToc3><a href="#_Toc238450111">4.3.5<span style='color:windowtext;
text-decoration:none'>          </span>FDO Vector classes<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>25</span></a></p>

<p class=MsoToc3><a href="#_Toc238450112">4.3.6<span style='color:windowtext;
text-decoration:none'>          </span>FDO MultiString &amp; MultiUnicode
classes<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>26</span></a></p>

<p class=MsoToc3><a href="#_Toc238450113">4.3.7<span style='color:windowtext;
text-decoration:none'>          </span>Virtual Property Handler class &amp;
related interface<span style='color:windowtext;display:none;text-decoration:
none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>26</span></a></p>

<p class=MsoToc3><a href="#_Toc238450114">4.3.8<span style='color:windowtext;
text-decoration:none'>          </span>Obsolete methods<span style='color:windowtext;
display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>28</span></a></p>

<p class=MsoToc3><a href="#_Toc238450115">4.3.9<span style='color:windowtext;
text-decoration:none'>          </span>Instance methods not found on some
CmObject class<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>28</span></a></p>

<p class=MsoToc3><a href="#_Toc238450116">4.3.10<span style='color:windowtext;
text-decoration:none'>        </span>IVwCacheDa interface<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>28</span></a></p>

<p class=MsoToc3><a href="#_Toc238450117">4.3.11<span style='color:windowtext;
text-decoration:none'>        </span>ScrFdo<span style='color:windowtext;
display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>28</span></a></p>

<p class=MsoToc3><a href="#_Toc238450118">4.3.12<span style='color:windowtext;
text-decoration:none'>        </span>Porting assemblies<span style='color:windowtext;
display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>28</span></a></p>

<p class=MsoToc3><a href="#_Toc238450119">4.3.13<span style='color:windowtext;
text-decoration:none'>        </span>Unit tests<span style='color:windowtext;
display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>29</span></a></p>

<p class=MsoToc3><a href="#_Toc238450120">4.3.14<span style='color:windowtext;
text-decoration:none'>        </span>What won’t work yet<span style='color:
windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>29</span></a></p>

<p class=MsoToc2><a href="#_Toc238450121">4.4<span style='color:windowtext;
text-decoration:none'>         </span>A Worked Example<span style='color:windowtext;
display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>29</span></a></p>

<p class=MsoToc3><a href="#_Toc238450122">4.4.1<span style='color:windowtext;
text-decoration:none'>          </span>Fix FDO ‘using’ declarations<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>29</span></a></p>

<p class=MsoToc3><a href="#_Toc238450123">4.4.2<span style='color:windowtext;
text-decoration:none'>          </span>Make everything use interfaces and Tags<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>29</span></a></p>

<p class=MsoToc3><a href="#_Toc238450124">4.4.3<span style='color:windowtext;
text-decoration:none'>          </span>Undotasks/UnitOfWork<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>30</span></a></p>

<p class=MsoToc3><a href="#_Toc238450125">4.4.4<span style='color:windowtext;
text-decoration:none'>          </span>Object Creation<span style='color:windowtext;
display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>30</span></a></p>

<p class=MsoToc3><a href="#_Toc238450126">4.4.5<span style='color:windowtext;
text-decoration:none'>          </span>Get rid of calls to PropChanged<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>31</span></a></p>

<p class=MsoToc3><a href="#_Toc238450127">4.4.6<span style='color:windowtext;
text-decoration:none'>          </span>Dealing with HVOs<span style='color:
windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>31</span></a></p>

<p class=MsoToc3><a href="#_Toc238450128">4.4.7<span style='color:windowtext;
text-decoration:none'>          </span>Implementations of PropChanged<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>31</span></a></p>

<p class=MsoToc3><a href="#_Toc238450129">4.4.8<span style='color:windowtext;
text-decoration:none'>          </span>Writing systems and multistrings<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>32</span></a></p>

<p class=MsoToc3><a href="#_Toc238450130">4.4.9<span style='color:windowtext;
text-decoration:none'>          </span>Stuff on the implementation class<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>32</span></a></p>

<p class=MsoToc3><a href="#_Toc238450131">4.4.10<span style='color:windowtext;
text-decoration:none'>        </span>Valid objects, dummy objects, and the like<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>32</span></a></p>

<p class=MsoToc3><a href="#_Toc238450132">4.4.11<span style='color:windowtext;
text-decoration:none'>        </span>Working with flids<span style='color:windowtext;
display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>32</span></a></p>

<p class=MsoToc3><a href="#_Toc238450133">4.4.12<span style='color:windowtext;
text-decoration:none'>        </span>Vanished methods<span style='color:windowtext;
display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>33</span></a></p>

<p class=MsoToc3><a href="#_Toc238450134">4.4.13<span style='color:windowtext;
text-decoration:none'>        </span>Wrapping up<span style='color:windowtext;
display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>33</span></a></p>

<p class=MsoToc1><a href="#_Toc238450135">5<span style='color:windowtext;
text-decoration:none'>       </span>Unit Test Framework<span style='color:windowtext;
display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>33</span></a></p>

<p class=MsoToc2><a href="#_Toc238450136">5.1<span style='color:windowtext;
text-decoration:none'>         </span>FdoTestBase (abstract)<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>33</span></a></p>

<p class=MsoToc2><a href="#_Toc238450137">5.2<span style='color:windowtext;
text-decoration:none'>         </span>PersistingBackendProviderTestBase
(abstract)<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>33</span></a></p>

<p class=MsoToc2><a href="#_Toc238450138">5.3<span style='color:windowtext;
text-decoration:none'>         </span>MemoryOnlyBackendProviderTestBase
(abstract)<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>34</span></a></p>

<p class=MsoToc1><a href="#_Toc238450139">6<span style='color:windowtext;
text-decoration:none'>       </span>Starting Flex-The window Frame<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>34</span></a></p>

<p class=MsoNormal>&nbsp;</p>

<span style='font-size:11.0pt;line-height:115%;font-family:"Calibri","sans-serif"'><br
clear=all style='page-break-before:always'>
</span>

<p class=MsoNormal>&nbsp;</p>

<h1><a name="_Toc238450049">1<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>General issues and attitudes</a></h1>

<h2><a name="_Toc238450050">1.1<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Code quality should improve</a></h2>

<p class=MsoNormal>It might seem as if this should go without saying, but I
want to emphasize it anyway: the primary goal of the re-architecture is to
improve the code: to make it easier to maintain, to enhance, and to keep free
of bugs. If you find yourself tempted to do something you think is ugly and
prone to cause bugs later because something is awkward to fix properly for the
new architecture, resist the temptation! If you can’t think of a clean,
maintainable way to get something working again, get help. If there’s a problem
with the new architecture, Randy and I want to know and fix it, not have people
do bad things to work around it.</p>

<h2><a name="_Toc238450051">1.2<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Follow the ‘DRY’ principle</a></h2>

<p class=MsoNormal>That is, “Don’t repeat yourself.” We want to be removing
code duplication wherever possible, and certainly not introducing it. If you
find yourself writing or modifying essentially the same algorithm in two
places, figure out a way to put the common parts in just one place. The clean
code, design patterns, and agile principles books are good places to learn
techniques for doing this. If you can’t think of a way to avoid duplication,
ask at least one other person for ideas.</p>

<p class=MsoNormal>One possible exception is algorithms that are needed in both
C++ code and C# code. If there is only a moderate amount of duplication, it may
not be worth the trouble to wrap everything necessary in COM interfaces. In
such cases (and anywhere else you can’t avoid duplication), comment in both
places conspicuously indicating that the duplicate needs to be kept in sync.</p>

<h2><a name="_Toc238450052">1.3<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Unit tests</a></h2>

<p class=MsoNormal>It's probably not feasible to get to a point where
everything is tested in the new architecture, but try to ensure that you have
unit tests for whatever you need to change. The book on working with legacy
code is full of ideas about how to get just the part you need to work on under
test.</p>

<p class=MsoNormal>A key idea in that book is that a unit test should run in
less than a tenth of a second. Unit tests should not access databases or files.
The new architecture should allow all tests (except of the BEPs themselves) to
run using a memory-only backend provider. Slow tests are probably really
integration tests (involving real instances of dependencies rather than some
kind of stub) and may need to be reworked if they are needed as unit tests. (It
may be worth keeping the integration test, too.)</p>

<h2><a name="_Toc238450053">1.4<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Null object pattern</a></h2>

<p class=MsoNormal>Current best practice is to avoid the necessity for constant
checking for nulls. One of the best ways to do this is to have methods that
would otherwise return null return instead a “null object” that implements the
expected interface(s) in such a way that a client can achieve the right result
by calling the null object method in the same way as the method of the regular
object. I’d like people to be aware of this pattern and look for ways it could
help us.</p>

<h2><a name="_Toc238450054">1.5<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>General New Skills</a></h2>

<p class=MsoNormal>Refer to the document “New skills for a new architecture”
for stuff I hope everyone learns to apply.</p>

<h2><a name="_Toc238450055">1.6<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Old code still around</a></h2>

<p class=MsoNormal>Be aware that in many DLLs, especially FDO, there is a lot
of code around that is not actually built. Some of it is retained to make
integrations easier, some because we expect to finish porting it eventually.
Code that we definitely expect to need in some form at some point is indicated
using #ifdef WANTPORT; please continue this convention if you want to mark off
some part of a new DLL which you choose not to port immediately. Search such
code if you find yourself wanting a function that doesn’t exist and that you
think might once have had.</p>

<p class=MsoNormal>There are also complete files around that have their compile
action set to “None”, that is, they are in the project but not really live code.
This is misleading, but the files are useful both for integration, and possibly
because some of their functionality may eventually be needed. As I find such
files, I’m trying to make the situation more obvious by inserting #ifdef
FILE_GETS_BUILT around all the code.</p>

<h2><a name="_Toc238450056">1.7<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Build problems</a></h2>

<p class=MsoNormal>Mostly you should be able to do “nant remakefw”, “nant
mkall”, or “nant build all” in the WW branch. Once that succeeds, you can run
the FLEx skeleton (FLEx.exe, the target of LexTextExe). We don’t yet have a
skeleton of any of the other applications.</p>

<p class=MsoNormal>There are a few mysteries currently unsolved:</p>

<p class=MsoNormal>1.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; The views tests
sometimes report problems that are not repeatable on running them again
(especially when run as part of remakefw).</p>

<p class=MsoNormal>2.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; On Vista, I’ve also
had test failures that are apparently spurious in mklg and mkgenlib.</p>

<p class=MsoNormal>3.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; To pass all the FDO
unit tests you need to install the Firebird server. (See section 2.3
immediately below.) Even then, I’m seeing a mysterious thing in the Resharper
test runner where all the firebird tests are crossed out with a red line,
though it says all the tests pass.</p>

<h2><a name="_Toc238450057">1.8<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Installing Firebird Server</a></h2>

<p class=MsoNormal>Instructions for installing Firebird client/server is in [FW
branch]\Doc\FieldWorks Setup\FirebirdClientServerSetup.html.</p>

<h1><a name="_Toc238450058">2<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>FDO</a></h1>

<p class=MsoNormal>The main difference between FDO in the new architecture and
FDO in the old is that in the new FDO CmObjects hold all of their own state,
while in the old system, the ISILDataAccess cache held it all. (The old style
CmObjects did hold their HVOs, but all other data came by accessing the cache,
or by accessing SqlServer for some cases.) The ISILDataAccess implementation
now is on the client side of FDO and is a Façade for clients which cannot
access FDO directly, either because they were coded to the old interface
historically or because they need the flexibility of operating on configurable
properties based on flids. The Views code is the main client that should
continue to use it.</p>

<h2><a name="_Toc238450059">2.1<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Interfaces</a></h2>

<h3><a name="_Toc238450060">2.1.1<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>CmObject Interfaces</a></h3>

<p class=MsoNormal>All CmObjects have generated interfaces for the main
model-defined properties. As with the FW 6.0 system, these generated interfaces
are ‘partial’ interfaces, which can be augmented by hand-written code. These
interfaces are how all code outside of the FDO assembly is to interact with the
implementations of the domain objects (CmObjects). It doesn’t work like this
yet, of course, but that is where we want to external code to end up. Even
within the FDO assembly, the only legitimate use of the implementations of the
interfaces belongs in the new FDO.DomainImpl namespace. Code in the FDO
assembly that is outside this namespace is to only use the interfaces. This
also is the goal, but not yet the reality.</p>

<h3><a name="_Toc238450061">2.1.2<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Factory Interfaces</a></h3>

<p class=MsoNormal style='line-height:normal'><span style='font-size:12.0pt;
font-family:"Times New Roman","serif"'>The new FDO has basic, generated support
for a Factory interface for each concrete CmObject class in the model. These
generated interfaces are ‘partial’, so they can be augmented by hand-written
code for Create methods that cannot be easily generated. The basic, generated
Factory interface supports one Create method with no parameters. This basic
method is the replacement for the ‘new Foo()’ constructor.</span></p>

<p class=MsoNormal style='line-height:normal'><span style='font-size:12.0pt;
font-family:"Times New Roman","serif"'>Hand-written additions to factories need
to be added in two places. The first place is to add a new method to the
interface. This would be done in the “Foo\Src\FDO\FdoInterfaceDeclarations.cs”
file, as is done:</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;text-autospace:none'><span style='font-size:12.0pt;font-family:Consolas;
color:gray;background:black'>///</span><span style='font-size:12.0pt;
font-family:Consolas;color:lime;background:black'> </span><span
style='font-size:12.0pt;font-family:Consolas;color:gray;background:black'>&lt;summary&gt;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;text-autospace:none'><span style='font-size:12.0pt;font-family:Consolas;
color:gray;background:black'>///</span><span style='font-size:12.0pt;
font-family:Consolas;color:lime;background:black'> Additional interface
methods.</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;text-autospace:none'><span style='font-size:12.0pt;font-family:Consolas;
color:gray;background:black'>///</span><span style='font-size:12.0pt;
font-family:Consolas;color:lime;background:black'> </span><span
style='font-size:12.0pt;font-family:Consolas;color:gray;background:black'>&lt;/summary&gt;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;text-autospace:none'><span style='font-size:12.0pt;font-family:Consolas;
color:#FF8000;background:black'>public</span><span style='font-size:12.0pt;
font-family:Consolas;color:white;background:black'> </span><span
style='font-size:12.0pt;font-family:Consolas;color:#FF8000;background:black'>partial</span><span
style='font-size:12.0pt;font-family:Consolas;color:white;background:black'> </span><span
style='font-size:12.0pt;font-family:Consolas;color:#FF8000;background:black'>interface</span><span
style='font-size:12.0pt;font-family:Consolas;color:white;background:black'> </span><span
style='font-size:12.0pt;font-family:Consolas;color:#2B91AF;background:black'>ILgWritingSystemFactoryFdo</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;text-autospace:none'><span style='font-size:12.0pt;font-family:Consolas;
color:white;background:black'>{</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;text-autospace:none'><span style='font-size:12.0pt;font-family:Consolas;
color:white;background:black'>     </span><span style='font-size:12.0pt;
font-family:Consolas;color:gray;background:black'>///</span><span
style='font-size:12.0pt;font-family:Consolas;color:lime;background:black'> </span><span
style='font-size:12.0pt;font-family:Consolas;color:gray;background:black'>&lt;summary&gt;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;text-autospace:none'><span style='font-size:12.0pt;font-family:Consolas;
color:white;background:black'>     </span><span style='font-size:12.0pt;
font-family:Consolas;color:gray;background:black'>///</span><span
style='font-size:12.0pt;font-family:Consolas;color:lime;background:black'>
Create an ILgWritingSystem.</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;text-autospace:none'><span style='font-size:12.0pt;font-family:Consolas;
color:white;background:black'>     </span><span style='font-size:12.0pt;
font-family:Consolas;color:gray;background:black'>///</span><span
style='font-size:12.0pt;font-family:Consolas;color:lime;background:black'> </span><span
style='font-size:12.0pt;font-family:Consolas;color:gray;background:black'>&lt;/summary&gt;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;text-autospace:none'><span style='font-size:12.0pt;font-family:Consolas;
color:white;background:black'>     </span><span style='font-size:12.0pt;
font-family:Consolas;color:gray;background:black'>///</span><span
style='font-size:12.0pt;font-family:Consolas;color:lime;background:black'> </span><span
style='font-size:12.0pt;font-family:Consolas;color:gray;background:black'>&lt;param
name=&quot;icuLocale&quot;&gt;</span><span style='font-size:12.0pt;font-family:
Consolas;color:lime;background:black'>The ICU Locale</span><span
style='font-size:12.0pt;font-family:Consolas;color:gray;background:black'>&lt;/param&gt;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;text-autospace:none'><span style='font-size:12.0pt;font-family:Consolas;
color:white;background:black'>     </span><span style='font-size:12.0pt;
font-family:Consolas;color:gray;background:black'>///</span><span
style='font-size:12.0pt;font-family:Consolas;color:lime;background:black'> </span><span
style='font-size:12.0pt;font-family:Consolas;color:gray;background:black'>&lt;param
name=&quot;locale&quot;&gt;</span><span style='font-size:12.0pt;font-family:
Consolas;color:lime;background:black'>The regular locale</span><span
style='font-size:12.0pt;font-family:Consolas;color:gray;background:black'>&lt;/param&gt;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;text-autospace:none'><span style='font-size:12.0pt;font-family:Consolas;
color:white;background:black'>     </span><span style='font-size:12.0pt;
font-family:Consolas;color:gray;background:black'>///</span><span
style='font-size:12.0pt;font-family:Consolas;color:lime;background:black'> </span><span
style='font-size:12.0pt;font-family:Consolas;color:gray;background:black'>&lt;param
name=&quot;rightToLeft&quot;&gt;</span><span style='font-size:12.0pt;
font-family:Consolas;color:lime;background:black'>true for a right to left
writing system, otherwise false</span><span style='font-size:12.0pt;font-family:
Consolas;color:gray;background:black'>&lt;/param&gt;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;text-autospace:none'><span style='font-size:12.0pt;font-family:Consolas;
color:white;background:black'>     </span><span style='font-size:12.0pt;
font-family:Consolas;color:gray;background:black'>///</span><span
style='font-size:12.0pt;font-family:Consolas;color:lime;background:black'> </span><span
style='font-size:12.0pt;font-family:Consolas;color:gray;background:black'>&lt;param
name=&quot;defaultSerif&quot;&gt;</span><span style='font-size:12.0pt;
font-family:Consolas;color:lime;background:black'>Name of the default Serif
font</span><span style='font-size:12.0pt;font-family:Consolas;color:gray;
background:black'>&lt;/param&gt;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;text-autospace:none'><span style='font-size:12.0pt;font-family:Consolas;
color:white;background:black'>     </span><span style='font-size:12.0pt;
font-family:Consolas;color:gray;background:black'>///</span><span
style='font-size:12.0pt;font-family:Consolas;color:lime;background:black'> </span><span
style='font-size:12.0pt;font-family:Consolas;color:gray;background:black'>&lt;param
name=&quot;defaultSansSerif&quot;&gt;</span><span style='font-size:12.0pt;
font-family:Consolas;color:lime;background:black'>Name of the default sans
serif font</span><span style='font-size:12.0pt;font-family:Consolas;color:gray;
background:black'>&lt;/param&gt;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;text-autospace:none'><span style='font-size:12.0pt;font-family:Consolas;
color:white;background:black'>     </span><span style='font-size:12.0pt;
font-family:Consolas;color:gray;background:black'>///</span><span
style='font-size:12.0pt;font-family:Consolas;color:lime;background:black'> </span><span
style='font-size:12.0pt;font-family:Consolas;color:gray;background:black'>&lt;returns&gt;&lt;/returns&gt;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;text-autospace:none'><span style='font-size:12.0pt;font-family:Consolas;
color:white;background:black'>     </span><span style='font-size:12.0pt;
font-family:Consolas;color:#2B91AF;background:black'>ILgWritingSystem</span><span
style='font-size:12.0pt;font-family:Consolas;color:white;background:black'>
Create(</span><span style='font-size:12.0pt;font-family:Consolas;color:#FF8000;
background:black'>string</span><span style='font-size:12.0pt;font-family:Consolas;
color:white;background:black'> icuLocale, </span><span style='font-size:12.0pt;
font-family:Consolas;color:#FF8000;background:black'>int</span><span
style='font-size:12.0pt;font-family:Consolas;color:white;background:black'>
locale, </span><span style='font-size:12.0pt;font-family:Consolas;color:#FF8000;
background:black'>bool</span><span style='font-size:12.0pt;font-family:Consolas;
color:white;background:black'> rightToLeft, </span><span style='font-size:12.0pt;
font-family:Consolas;color:#FF8000;background:black'>string</span><span
style='font-size:12.0pt;font-family:Consolas;color:white;background:black'>
defaultSerif, </span><span style='font-size:12.0pt;font-family:Consolas;
color:#FF8000;background:black'>string</span><span style='font-size:12.0pt;
font-family:Consolas;color:white;background:black'> defaultSansSerif);</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;text-autospace:none'><span style='font-size:12.0pt;font-family:Consolas;
color:white;background:black'>}</span></p>

<p class=MsoNormal><br>
The implementation additions for factories would go in the “Foo\Src\FDO\DomainImpl\FdoFactoryAdditions.cs”
file.</p>

<h3><a name="_Toc238450062">2.1.3<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Repository Interfaces</a></h3>

<p class=MsoNormal>The new FDO has basic, generated, support for a Repository
interface for each CmObject class (concrete and abstract) in the model. These
generated interfaces are ‘partial’, so they can be augmented by hand-written
code. The basic Repository interface supports object access by HVO or Guid, as
well as access to all instances of the class of the Repository, <b>plus</b> all
of the subclasses of the class. A call to the ICmObjectRepository’s AllInstances()
method will return every object in the data store. A count of all instances is
included in the basic Repository interface.</p>

<p class=MsoNormal>In general you may use the following regular expression for
converting anything using CmObject. CreateFromDBObject() type interfaces to a
repository </p>

<p class=MsoNormal>by finding</p>

<p class=Code>“= {[^.]*}.CreateFromDBObject\({[^.]*}, ”</p>

<p class=MsoNormal>and replacing with</p>

<p class=Code>“=
\2\.ServiceLocator\.GetInstance\&lt;I\1Repository\&gt;()\.GetObject(”</p>

<p class=MsoNormal>Hand-written additions to repositories need to be added in
two places. The first place is to add a new method to the interface. This would
be done in the “Foo\Src\FDO\FdoRepositoryInterfaceAdditions.cs”. Hand-written
implementation for repository additions will go in the “Foo\Src\FDO\DomainImpl\
FdoRepositoryAdditions.cs”. (The hand-written and generated Repository
implementation code probably ought to move to FDO.Interface namespace, since
Repository implementations are technically Infrastructure, and the files moved,
but it hasn’t been done yet.)</p>

<h3><a name="_Toc238450063">2.1.4<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>FDO Vector interfaces</a></h3>

<p class=MsoNormal>The new system primarily uses standard .Net&nbsp;
collection/list interfaces, such as IList, or ICollection, but there are
additional interfaces, as well. There is a new IFdoVector interface, which adds
access to the entire array of the HVOs of the contained objects (much as is
done with the ToArray() method), as well as the array of object Guids in the
vector. This interface is public, and any code can use it. There is an internal
interface that is used to support for Undo/Redo, and persistence. The
expectation is that this access will stay internal and only be used internally
by ‘authorized’ code, even internally.</p>

<p class=MsoNormal>There are several other interfaces defined to support
vectors, some public, but others internal. These use generics, which allow for
type safe vectors. A main division of vectors in these interfaces support
collections vs. sequences of objects. Some vectors allow duplicate objects
(i.e., reference sequence properties), but many do not (i.e., owning vectors
and collection properties).</p>

<p class=MsoNormal>One consequence of going to the standard interfaces is that
‘Add’ no longer returns the thing added. Combined with the move to factories,
this means that code like this needs to be changed:</p>

<p class=MsoNormal>LexSense newSense = myEntry.Senses.Add(new LexSense());</p>

<p class=MsoNormal>Todo: finalize decision about what to replace that with and
document.</p>

<h3><a name="_Toc238450064">2.1.5<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Alternative string and unicode interfaces</a></h3>

<p class=MsoNormal>The string and Unicode alternative classes are supported by
interfaces. The base interface is ITsMultiString, but it is the base for other
interfaces, which contain the public accessors that are normally on the
alternative classes.</p>

<h3><a name="_Toc238450065">2.1.6<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Internal interfaces</a></h3>

<p class=MsoNormal>There are numerous internal interface additions included in
the FDO assembly. For instance, there is an ICmObjectInternal interface
(derives from ICmObject interface)) that adds a bunch of methods to CmObject
that are only used inside the FDO assembly. There are currently a collection of
internal interface additions to various factories, the methods of which are
also internal to the FDO assembly. The interface additions and implementations can
be found in the files mentioned, above.</p>

<h2><a name="_Toc238450066">2.2<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Implementations</a></h2>

<p class=MsoNormal>All generated interfaces of the various types have generated
partial implementation classes. The implementations are normally in the
FDO.DomainImpl namespace. (Even the repository implementations are there, but
they really belong in the FDO.Infrastructure namespace and will likely be moved
there at some point.)</p>

<h3><a name="_Toc238450067">2.2.1<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>CmObject Implementations</a></h3>

<p class=MsoNormal>All of these domain object interfaces also have generated
partial implementation classes. These classes can be augmented by using partial
classes, as is done in the FW 6.0 code. The generated classes are in the
FDO.DomainImpl namespace, which ought not be used by code that is outside of
that namespace.</p>

<h3><a name="_Toc238450068">2.2.2<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Factory Implementations</a></h3>

<p class=MsoNormal>Eventually (hopefully before the year is over), all CmObject
creation will be handled by factories (which already exist). At some point
during the year, the code generator can change all public constructors to
internal, which will kind of force the issue. :-)</p>

<h3><a name="_Toc238450069">2.2.3<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Repository Implementations</a></h3>

<p class=MsoNormal>The repository implementations are currently in the
FDO.DomainImpl namespace, but they will likely be relocated to their correct
‘home’ in the FDO-Infrastructure namespace.</p>

<p class=MsoNormal>The generated interfaces and the implementations can be
augmented with hand-written code in the same way the domain objects and
factories can be augmented.</p>

<h3><a name="_Toc238450070">2.2.4<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>FDO Vector implementations</a></h3>

<p class=MsoNormal>The implementation classes for the vector classes are in the
FDO.DomainImpl namespace. The expectation is that code will use the interfaces,
rather than the implementation classes outside of the FDO assembly, and that a
good bit of code inside it will do the same.</p>

<h3><a name="_Toc238450071">2.2.5<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>FDO MultiString &amp; MultiUnicode classes</a></h3>

<p class=MsoNormal>The two main multi-foo accessor classes implement the
ITsMultiString C++ interface, as well as some additional C# interfaces. The
base ITsMultiString interface provides for basic ‘get/set’ operations.
Additional interfaces (which derive from ITsMultiString) provide for more
methods that code is used to seeing on the older multi-foo implementations.</p>

<h2><a name="_Toc238450072">2.3<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Statics on CmObject Implementation classes</a></h2>

<p class=MsoNormal>It is not desirable for any CmObject implementation class to
have any public and static properties, methods, or constants. Such code
prevents the long-term goal of splitting up FDO into Bounded Contexts, since
that type of code completely binds client code to the implementation classes,
which is not&nbsp; good.</p>

<p class=MsoNormal>To the end of decoupling code that should not be coupled,
the new FDO system has provided new ways to access the current constants. There
are new FooTag classes (also partial classes) that mirror the CmObject class
hierarchy and which hold all constants. The old stuff is no longer generated.</p>

<p class=MsoNormal>It would also be good that by the end of the re-architecting
effort that there be no public static properties or methods on any CmObject
implementation class. Internal, protected, or private, yes, but not public.
Eventually the whole implementation class will be internal.</p>

<h2><a name="_Toc238450073">2.4<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>FDO &amp; UOW interaction</a></h2>

<p class=MsoNormal>The CmObjects register all data changes with the UOW. There
is no need for any other code to do this. The CmObjects are not strict POCOs, I
guess, since they do this registration.</p>

<p class=MsoNormal>There are ways to remove this to make CmObjects true POCOs,
but the price could be lower performance at Commit time. The Commit code would
have to be able to tell which objects in the IdentityMap were new, deleted, or
modified. It can be done, of course, but it may not be cheap.</p>

<p class=MsoNormal>A probable way to make CmObjects true POCOs would have the
Factories add the new kid to the UOW. Repositories could be pressed into
service for deletions with a Remove method. The really hard part would be the
modified objects. There would need to be a snapshot of some sort at load time,
which is compared to the current state at save time, and those with differences
would be saved as modified. The Undo/Redo system would have to be revised quite
a bit to support this kind of world, as well.</p>

<h2><a name="_Toc238450074">2.5<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>FDO &amp; Persistence Code Interaction</a></h2>

<p class=MsoNormal>There is no access between the domain objects and the
persistence code. Nor, should there ever be such a need.</p>

<h2><a name="_Toc238450075">2.6<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>FdoCache</a></h2>

<p class=MsoNormal>I believe that the FdoCache class will be removed at some
point. In the 6.0 system, it served many disconnected functions. For instance,
it provided C#-friendly access to the metadata cache as well as the actual
cache. These C# methods can easily be added to the base C++ interface, so are
not needed on FdoCache. (Indeed, many of them have already been removed.)</p>

<h2><a name="_Toc238450076">2.7<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Service Locator and Dependency Injection</a></h2>

<p class=MsoNormal>The FdoCache provides for access to a connection-specific
Service Locator instance, which, in turn, provides for access to interfaces for
factories, repositories, metadata cache, and the ISILDataAccess interface,
among other things. To the extent that we are able to use Dependency Injection
within FDO itself, then use of the Service Locator will diminish.</p>

<p class=MsoNormal>We’ll gradually build up a list of what services one can
count on finding in the service locator. I think we will probably gradually
give it specialized methods for common ones. For test code, we will not want to
pay the penalty of creating all such objects in advance, but on the other hand,
we don’t want tests to break because some method that the test is only using
coincidentally needs a service that it previously did not. I think the solution
may be a default test-only service locator which knows how to create a minimal
default instance of any of the standard interfaces on demand.</p>

<p class=MsoNormal>One primary idea of DI is that if a class depends on some
other class, it should be at least possible for client code to provide
(“inject”) the dependency, especially in order to use a test stub. One way to
do this is with additional constructors which take the dependency objects as
arguments, while the default constructors just create the usual dependency
object. This gets tricky over lots of layers, which is why we have the service
locator for things that are very widely used.</p>

<h2><a name="_Toc238450077">2.8<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>HVOs</a></h2>

<p class=MsoNormal>The HVOs in the new system are honest handles in the new
system. They are only valid for that one session. One should never store them
in a configuration file and expect them to be valid the next session. The
object’s Guid is always unique and can be used form one session to the next to
get at the same object.</p>

<p class=MsoNormal>The HVOs are not stored in any of the data stores, nor is
there any reason to do so in the future, given that they are now honest,
temporary, handles.</p>

<h2><a name="_Toc238450078">2.9<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Back references</a></h2>

<p class=MsoNormal style='line-height:normal'><span style='font-size:12.0pt;
font-family:"Times New Roman","serif"'>Back references were declared last fall
to not automatically be a natural part of the model of the objects referred to;
rather, the primary way to access them is through the Repository for the
referring class. That is, instead of, say, ICmPossibility having a “property”
RefsFromStatusOfLexSense, the LexSenseRepository has (read: “will have”) a
method SensesWithStatus(ICmPossibility status).</span></p>

<p class=MsoNormal style='line-height:normal'><span style='font-size:12.0pt;
font-family:"Times New Roman","serif"'>There are cases where such associations
are bi-directional, and these associations need to be supported within FDO when
found. By saying something is “bidirectional,” we don’t mean that there is (as
yet) a way to just set a flag and make both directions available; rather, a
“bidirectional” relationship is something which in model terms makes sense as a
property of objects at both ends.</span></p>

<p class=MsoNormal style='line-height:normal'><span style='font-size:12.0pt;
font-family:"Times New Roman","serif"'>For example, the segments of a text
paragraph is a very natural property of a paragraph, though the actual link in
the model is the InstanceOf property of a CmBaseAnnotation. (Actually it’s such
a natural property that we might even change the model to make it the primary
one, but that’s another story.) There is no automatically-generated way to get
the segments of a paragraph, but the repository for CmBaseAnnotation can
provide the annotations which have that paragraph as their InstanceOf, and from
these the ones with the right annotation type can be selected and ordered by
their BeginOffset. Code to do this should be written as a property of
IStTxtPara, and an attribute set (as described below) to indicate that this
method should be used as a “virtual property” visible to views. Ideally code
should also be written to keep this virtual property up to date and notify
views of changes as relevant properties of CmBaseAnnotations change.</span></p>

<p class=MsoNormal style='line-height:normal'><span style='font-size:12.0pt;
font-family:"Times New Roman","serif"'>On the other hand, while it makes
perfectly good sense to retrieve from the LexSenseRepository the senses which
have a particular status, “Senses which have this status” does not make sense
as a property of CmPossibility. (It’s a fundamental concept in our model that
paragraphs have segments, relevant to almost every paragraph, but not that list
items have “senses which have this status”; indeed, the latter is utterly
meaningless for any list item that isn’t in the Status possibility list.)</span></p>

<p class=MsoNormal style='line-height:normal'><span style='font-size:12.0pt;
font-family:"Times New Roman","serif"'>Occasionally, a particular view may want
to display a back-reference property that doesn’t “make sense” as a virtual
property of the object. For example, we might want a view that shows the
various items in the Status list and (for each one) the senses that have that
status. We do not want to make an unnatural virtual property in our main domain
model (and maintain it for every CmPossibility) just to handle this. FDO exists
to support the domain model, and not such ‘extras’. The suggested way to
provide support for such one-off relationships is to use decorators for the MDC
and the SDA, thus giving CmPossibility a ‘property’ that exists for the one
view but not generally as part of the domain model. This would leave FDO out of
the loop, which makes sense for properties which are not a natural part the
domain model.</span></p>

<p class=MsoNormal style='line-height:normal'><a name="_anchor_1"></a><span
style='font-size:12.0pt;font-family:"Times New Roman","serif"'>Between cases
where the back reference property is such a natural part of the model that it
might well have been the primary property and cases where it would make no
sense at all there are probably a lot of cases where the answer is much less
obvious. We’ll have to consider these as we come to them.</span> <a>A good clue
is whether you can think of a straightforward name (like “Segments”) for the
backref property; if “RefsFromStatusOfSense” is the best that can be done, it’s
probably not a natural property!</a><span class=MsoCommentReference><span
style='font-size:8.0pt'><a class=msocomanchor id="_anchor_1"
onmouseover="msoCommentShow('_anchor_1','_com_1')"
onmouseout="msoCommentHide('_com_1')" href="#_msocom_1" language=JavaScript
name="_msoanchor_1">[RBR1]</a>&nbsp;</span></span></p>

<h2><a name="_Toc238450079">2.10<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span>FDO Namespaces</a></h2>

<p class=MsoNormal>The main FDO namespace is SIL.FieldWorks.FDO (shortened to
FDO for purposes of discussion here). Files in the root folder should all be in
this namespace (although not all files that are currently there will survive
for long there). The basic folder structure seen in the FDO project file maps
to additional namespaces. (Resharper helps encourage this, as you may have
observed.) The lower level namespaces are:</p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt'>FDO.Application</p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt'>FDO.Application.Impl</p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt'>FDO.DomainImpl</p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt'>FDO.DomainServices</p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt'>FDO.Infrastructure</p>

<p class=MsoNormal>FDO.Infrastructure. Impl</p>

<p class=MsoNormal>(There are other folders in Perforce under the FDO folder,
but those are not part of the FDO assembly.)</p>

<h3><a name="_Toc238450080">2.10.1<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span>SIL.FieldWorks.FDO</a></h3>

<p class=MsoNormal>This namespace holds the interface declarations for the
domain objects, repositories, and factories, as well as a lot of old (and in
some cases obsolete and not compiled code files) legacy code, which may not
really belong in this namespace. For instance, FdoCache is probably not really
needed at this point, but it is hard to get rid of right now. Other code files
were easier to leave in this namespace, as long as significant integrations
were being made. As the integrations dwindle, it would be good to review what
is left in this namespace to make sure it really belongs there.</p>

<p class=MsoNormal>This namespace should be the most widely used of all the FDO
namespaces, outside of the FDO assembly.</p>

<h3><a name="_Toc238450081">2.10.2<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span>SIL.FieldWorks.FDO.Application</a></h3>

<p class=MsoNormal>This namespace holds the ISILDataAccessManaged interface,
which extends the regular ISILDataAccess interface. It is a Façade because it
provides an alternative API for clients such as the views code that can’t use
FDO objects directly. Clients that find it easier to not use FDO directly,
because they are more general in nature are also good candidates for using the
Facade.</p>

<p class=MsoNormal>The name of the implementation class was selected some time
back to be more helpful in knowing what the class did, than the interface name
is. (One can argue how well the new name achieves that goal, I suppose.)</p>

<p class=MsoNormal>This namespace also holds a decorator base class of the SDA
implementation. Clients who need to create a decorator will need to use this
namespace to get at that abstract base class, but I’m not sure many other
external (to the FDO assembly) clients will need to use it.</p>

<h3><a name="_Toc238450082">2.10.3<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span>SIL.FieldWorks.FDO.Application.Impl</a></h3>

<p class=MsoNormal>This namespace holds the implementation of the
ISILDataAccessManaged interface. Right now, nothing else is in it, but other
classes can be added here, as needed.</p>

<p class=MsoNormal><span style='color:red'>[NB: Unless you are working with
FDO’s IOC code, you should never include this namespace in a ‘using’
statement.]</span></p>

<h3><a name="_Toc238450083">2.10.4<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span>SIL.FieldWorks.FDO.DomainImpl</a></h3>

<p class=MsoNormal>This namespace contains the implementations of the main
domain object interfaces, as well as some implementations of other interfaces,
such as those that support the vector collections and multistring classes.
There are a few directly implemented classes with no interfaces, some being
public. The idea is that no external FDO client code is to use this namespace
or anything in it, but we aren’t fully there yet. No external client code can
access the domain object implementations classes, or create them via
Constructors, since that is all internal now. The Repository implementations
have now been moved into their proper home in the
“SIL.FieldWorks.FDO.Infrastructure. Impl” namespace.</p>

<p class=MsoNormal><span style='color:red'>[NB: Unless you are working with
FDO’s IOC code, you should never include this namespace in a ‘using’
statement.]</span></p>

<h3><a name="_Toc238450084">2.10.5<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span>SIL.FieldWorks.FDO.DomainServices</a></h3>

<p class=MsoNormal>This namespace is fairly new. The idea for it is that code
that provides domain-aware services goes into this namespace. Right now, it
holds all manner of static code that once lived on CmObject implementation
classes, which had to move elsewhere to make those classes internal. Some of
that code may well belong elsewhere, but for now it resides here to get it off
the domain classes.</p>

<h3><a name="_Toc238450085">2.10.6<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span>SIL.FieldWorks.FDO.Infrastructure</a></h3>

<p class=MsoNormal>This namespace holds interfaces and code that are outside of
the domain layer, but not in the higher layers, such as application or UI. Code
in this namespace would be the UOW, IdentityMap, Undo/Redo, and the interfaces
for the BEPs, along with other code.</p>

<p class=MsoNormal>The expectation is that FDO will make use of interfaces or
code in this namespace, as will external clients, where such access if
appropriate. (Some code is internal, so is not available to external clients.)</p>

<h3><a name="_Toc238450086">2.10.7<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span>SIL.FieldWorks.FDO.Infrastructure. Impl</a></h3>

<p class=MsoNormal>This namespace holds the implementations of the various BEPs,
as well as implementations of several other interfaces. It also holds some
classes that have no interface, such as the IdentityMap. These might need an
interface in order to really hide the implementations, even in the FDO
assembly.</p>

<p class=MsoNormal>Once a BEP is selected for use in FW 7.0, the unused ones
can be ‘mothballed’. This could be taken clear out of the system, or simply disabled.
Project references to database dlls that are not shipped can also be removed
from the FDO project.</p>

<p class=MsoNormal><span style='color:red'>[NB: Unless you are working with
FDO’s IOC code, you should never include this namespace in a ‘using’
statement.]</span></p>

<h1><a name="_Toc238450087">3<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Supporting Infrastructure</a></h1>

<p class=MsoNormal>This section covers selected infrastructure code, not all of
it. The parts that are covered are particularly interesting, since they relate
a good deal to the new FDO domain layer.</p>

<h2><a name="_Toc238450088">3.1<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Persistence</a></h2>

<p class=MsoNormal>A key component in the new architecture is the persistence
mechanism. In the past, access to SqlServer was completely open to any code
anywhere. In the new architecture, this is not the case. Appropriate public
access is allowed, but to a very limited extent. Three new interfaces (and
implementations of them) in the new architecture manage this access. One of the
new interfaces is public and is available to all client code. The other two
interfaces are internal and not available to code outside of the FDO assembly.
All three of the interfaces are implemented by one C# class in the FDO
assembly.</p>

<p class=MsoNormal>1.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IDataSetup interface</p>

<p class=MsoNormal>This interface is available to any C# code. The idea is that
this interface will expose behaviors, such as
Open/Close/Backup/Restore/Delete/etc. on the user’s data. The interface also
supports importing and exporting from one supported data store system to
another. One can import the converted XML from FW 6.0 into any of the supported
storage systems. One can also export all of the data from one supported system
to another.</p>

<p class=MsoNormal>There are several methods defined by this interface, but the
expectation is that more will be added, as needed, to support the end-user’s
tasks.</p>

<p class=MsoNormal>There is one method on this interface that allows client
code to ‘eager load’ whatever objects it wants. The design allows for any
number of definitions of bundles of objects to be reconstituted.</p>

<p class=MsoNormal>2.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IDataReader interface</p>

<p class=MsoNormal>This interface is ‘internal’, which means that code outside
of the FDO assembly cannot get to it to use its methods. The expectation is
that no more methods need to be added to this interface, than are already
defined on it.</p>

<p class=MsoNormal>This interface provides for the “R” in the basic CRUD
database operations.</p>

<p class=MsoNormal>This interface essentially is a Repository, since it
operates on Aggregate Roots, and has direct access to the data store
implementation. It is essentially an implementation of the Strategy pattern, in
that the implementation is injected (Dependency Injection) into the publically
accessible Repositories of each CmObject class.</p>

<p class=MsoNormal>No code other than the main Repositories in the FDO assembly
is authorized to use the IDataReader interface. There is no way to prevent its
use, but it isn’t authorized, so should not be done.</p>

<p class=MsoNormal>3.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IDataStorer interface</p>

<p class=MsoNormal>This interface is ‘internal’, which means that code outside
of the FDO assembly cannot get to it to use its methods. There is one ‘Commit”
method defined on this interface, and no other ones need be added.</p>

<p class=MsoNormal>This interface provides for the “C”, “U”, and “D” in the
basic CRUD database operations.</p>

<p class=MsoNormal>This interface provides a way for the UOW management system
to persist the actual data changes (create/delete/update).</p>

<p class=MsoNormal>No code other than the UOW management system in the FDO
assembly is authorized to use the IDataStorer interface. Even for the UOW
system, only the “Commit” method is authorized to use this interface There is
no way to prevent its use, but it isn’t authorized, so should not be done.</p>

<p class=MsoNormal>One internal, abstract, base class (FDOBackendProvider)
implements all three of these interfaces. There is one internal, sealed,
concrete subclass of FDOBackendProvider for each of the supported storage
systems, as well as one subclass that is used for memory-only ‘data store’
usages, such as unit tests. Currently, there are four supported data store
systems, as well as the memory-only system (Berkeley DB, Db4o, Firebird, and
XML).</p>

<p class=MsoNormal>All of these systems work with the XML representation of
each CmObject instance. Other data storage systems can be added, as needed. If
these new systems read/write these XML packets, they can also derive from
FDOBackendProvider. If they wish to use some other storage system, such as an
NHibernate+regular RDBMS, then there will need to be some refactoring of
FDOBackendProvider to support that kind of persistence mechanism.</p>

<h3><a name="_Toc238450089">3.1.1<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Creating a new BEP</a></h3>

<p class=MsoNormal>There could be two kinds of new BEPs developed. One would
continue the xml key/value type BEP. The other could be anything else, such as
an NHibernate-based RDBMS BEP.</p>

<h4>3.1.1.1<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Common implementation steps</h4>

<p class=MsoNormal>1.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Add basic support for
the new underlying data store. For example, I added the Db4o dll to the
DistFiles folder, and added a reference to it in from the FDO assembly. For
say, Firebird client-server, this would be an installation for Firebird.
(Firebird embedded is not installed, and the required files are just lying
around in DistFiles ready to be used.)</p>

<p class=MsoNormal>2.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Add a new item to the
FDOBackendProviderType enum for that BEP. (Do not commandeer any current BEP
code or enums. Make new ones.)</p>

<p class=MsoNormal>3.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Add one or more C#
files to the FDO project to access the new data store. The file(s) go in the
Src\FDO\Infrastructure\PersistenceImpl folder.</p>

<p class=MsoNormal>4.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Add a new case
statement to &quot;switch (m_backendProviderType)&quot; in the
FDO\DomainImpl\FdoServiceLocatorFactory.cs file to create the new BEP when
selected for use.</p>

<p class=MsoNormal>5.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Add a new unit test
class. (See 3.1.1.1.1 Unit testing BEPs for details.)</p>

<p class=MsoNormal>You can look over the various BEP implementation classes in
the FDO\Infrastructure\PersistenceImpl folder to get an idea of what needs to
be put into the new BEP file to get it to pass the BEP tests.</p>

<p class=MsoNormal>I've probably left something out, but the above stuff ought
to get you a good ways down the road to adding a new BEP.</p>

<h4>3.1.1.2<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>XML-based key/value BEPs</h4>

<p class=MsoNormal>This kind of BEP would be the easiest, since it can inherit
a lot of common behavior from the FDOBackendProvider base class. Subclasses <i>must</i>
implement two protected abstract methods and really should override the Commit
method (for systems that actually store data). They may override the Dispose
method, if they have anything to close down. There may be other code to add,
but that would be private to that BEP.</p>

<h5>3.1.1.2.1<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Firebird sample</h5>

<p class=MsoNormal>Using the current embedded Firebird BEP as an example (since
there may be other BEPs added, such as MySql or Postgres), we see the
following.</p>

<p class=MsoNormal>The CreateInternal method implementation would include one
or two queries that create the database with one table in it. The firebird BEP
has no explicit DB creation command (as a string), as creation of the file in
the right way is all that is done. The one table is created with this query
string:</p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal'><span style='font-size:12.0pt;font-family:Consolas;color:white;
background:black'>cmd.CommandText = </span><span style='font-size:12.0pt;
font-family:Consolas;color:lime;background:black'>&quot;CREATE TABLE MAIN (ID
INTEGER NOT NULL PRIMARY KEY,</span><span style='font-size:12.0pt;font-family:
"Times New Roman","serif";color:lime'> </span></p>

<p class=MsoNormal style='line-height:normal'><span style='font-size:12.0pt;
font-family:Consolas;color:lime;background:black'>XMLDATA BLOB SUB_TYPE
TEXT)&quot;</span><span style='font-size:12.0pt;font-family:Consolas;
color:white;background:black'>;</span></p>

<p class=MsoNormal>The StartupInternal implementation has one query in it,
along with some other C# code. That query is:</p>

<p class=MsoNormal style='line-height:normal'><span style='font-size:12.0pt;
font-family:Consolas;color:white;background:black'>cmd.CommandText = </span><span
style='font-size:12.0pt;font-family:Consolas;color:lime;background:black'>&quot;SELECT
* FROM MAIN&quot;</span><span style='font-size:12.0pt;font-family:Consolas;
color:white;background:black'>;</span></p>

<p class=MsoNormal>All rows are processed to get the xml, which is then used to
create CmObjectSurrogate instances for each row. The cost to fetch data for an
out-of-process client-server system is mitigated, since there is only one round
trip across the process boundary. (Indeed, the now removed SqlServer BEP ran
circles around everyone else with this one query, even though it was
cross-process, and everyone else was not.)</p>

<p class=MsoNormal>The Commit method would have only three queries in it:
Insert, Update, and Delete. The data is fed to the Commit method in such a way
that the implementation knows right off, which kind of operation is needed for
each object in gets.</p>

<h4>3.1.1.3<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Non-xml-based key/value BEPs</h4>

<p class=MsoNormal>This could be something like a regular RDBMS, with its
various tables and columns, such as the current FW 6.0 SqlServer system. There
could be other types, as well, such as an xml-based DB. There are none of these
at the moment, but if one were to be added, it would require refactoring the
FDOBackendProvider base class to support it. The common xml key/value code
would then probably move to a new subclass of FDOBackendProvider, and the
current BEPs would derive from that new class. Truly common code could stay on
FDOBackendProvider. If there were no such common code, then the new BEP would
have to implement all three of the interfaces (IDataSetup , IDataReader,and
IDataStorer), and see that it was injected properly.</p>

<h3><a name="_Toc238450090">3.1.2<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Unit Testing a new BEP</a></h3>

<p class=MsoNormal>It should be fairly easy to do unit tests on a new BEP,
since there are numerous unit tests already defined, and which are used for
testing all current BEPs.</p>

<h4>3.1.2.1<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Basic BEP Testing</h4>

<p class=MsoNormal>Basically, a new test class is created for the new BEP, and
it derives from one of two base classes to inherit its unit tests. The current
class structure is:</p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal'><span style='font-size:12.0pt;font-family:"Times New Roman","serif"'>PersistingBackendProviderTestBase
: FdoTestBase (Defines common unit tests for all BEPs.)</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal'><span style='font-size:12.0pt;font-family:"Times New Roman","serif"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
DB4oTests : PersistingBackendProviderTestBase (Embedded DB4o)</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal'><span style='font-size:12.0pt;font-family:"Times New Roman","serif"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
FirebirdEmbeddedTests : PersistingBackendProviderTestBase (Embedded Firebird)</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal'><span style='font-size:12.0pt;font-family:"Times New Roman","serif"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
BerkeleyDBTests : PersistingBackendProviderTestBase (Berkeley DB)</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal'><span style='font-size:12.0pt;font-family:"Times New Roman","serif"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
XMLTests : PersistingBackendProviderTestBase (XML)</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal'><span style='font-size:12.0pt;font-family:"Times New Roman","serif"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
MemoryOnlyTests : PersistingBackendProviderTestBase (In-memory DB)</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal'><span style='font-size:12.0pt;font-family:"Times New Roman","serif"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
PersistingClientServerBackendProviderTestBase :
PersistingBackendProviderTestBase<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
(Defines additional unit test for client-server BEPS.)</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal'><span style='font-size:12.0pt;font-family:"Times New Roman","serif"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
FirebirdClientServerTests : PersistingClientServerBackendProviderTestBase<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
(Client-Server Firebird)</span></p>

<p class=MsoNormal>All Client-Server BEPs <b><i>must</i></b> derive from
PersistingClientServerBackendProviderTestBase and override one method, which is
in the form:</p>

<p class=MsoNormal><span style='color:#FF8000;background:black'>protected</span><span
style='color:white;background:black'> </span><span style='color:#FF8000;
background:black'>override</span><span style='color:white;background:black'> </span><span
style='color:yellow;background:black'>FdoCache</span><span style='color:white;
background:black'> CreateCache()<br>
{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span style='color:#FF8000;background:black'>const</span><span
style='color:white;background:black'> </span><span style='color:#FF8000;
background:black'>string</span><span style='color:white;background:black'>
filename = </span><span style='color:lime;background:black'>&quot;TestLangProj.fdb&quot;</span><span
style='color:white;background:black'>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span style='color:#FF8000;background:black'>if</span><span
style='color:white;background:black'> (!m_internalRestart &amp;&amp; </span><span
style='color:yellow;background:black'>File</span><span style='color:white;
background:black'>.Exists(filename))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span style='color:yellow;background:black'>File</span><span
style='color:white;background:black'>.Delete(filename);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span style='color:#FF8000;background:black'>return</span><span
style='color:white;background:black'> BootstrapSystem(</span><span
style='color:#2B91AF;background:black'>FDOBackendProviderType</span><span
style='color:white;background:black'>.kFirebird, </span><span style='color:
#FF8000;background:black'>new</span><span style='color:white;background:black'>
</span><span style='color:#FF8000;background:black'>object</span><span
style='color:white;background:black'>[] { filename }, <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
m_loadType);<br>
}</span><br>
<br>
Everything else is handled by the base test class.</p>

<p class=MsoNormal>[NB: the filename must be (read: it is imperative that)
unique to all other BEP DB names. The test suite deletes the files when the
test fixture is setup, and creates them <i>ex-nihilo</i> before the tests are
run. To distinguish the embedded vs. client-server Firebird files, I prepend
‘cs’ to the file extension for the client-server Firebird file.]</p>

<h4>3.1.2.2<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>BEP ‘Port’ Testing</h4>

<p class=MsoNormal>Besides the above basic testing, the BEP test framework also
provides a way to ‘port’ data from each BEP to all other BEPs, including the
BEP of the same type. These tests are included in the “BEPPortTests” class
(derives from the .Net Object class). There are only two test methods, and
those are the only ones expected on this class, as they test the two ways one
can port from one BEP to another (i.e., source BEP previously opened, and
source BEP previously closed).</p>

<p class=MsoNormal>All new BEPs <i>must</i> participate in this port test
framework, and it is very easy to do so. One just needs to add two new instances
of a test helper class (BackendStartupParameter) to two lists, and ensure each
BackendStartupParameter is set to work for the respective BEP. Samples of this
for the two Firebird BEPs are:</p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal'><span style='font-size:12.0pt;font-family:Consolas;color:white;
background:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span style='font-size:12.0pt;font-family:Consolas;color:#FF8000;
background:black'>new</span><span style='font-size:12.0pt;font-family:Consolas;
color:white;background:black'> </span><span style='font-size:12.0pt;font-family:
Consolas;color:yellow;background:black'>BackendStartupParameter</span><span
style='font-size:12.0pt;font-family:Consolas;color:white;background:black'>(</span><span
style='font-size:12.0pt;font-family:Consolas;color:#2B91AF;background:black'>FDOBackendProviderType</span><span
style='font-size:12.0pt;font-family:Consolas;color:white;background:black'>.kFirebirdEmbedded,
</span><span style='font-size:12.0pt;font-family:Consolas;color:#2B91AF;
background:black'>BackendBulkLoadDomain</span><span style='font-size:12.0pt;
font-family:Consolas;color:white;background:black'>.All,</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal'><span style='font-size:12.0pt;font-family:Consolas;color:white;
background:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span style='font-size:12.0pt;font-family:Consolas;color:#FF8000;
background:black'>new</span><span style='font-size:12.0pt;font-family:Consolas;
color:white;background:black'> </span><span style='font-size:12.0pt;font-family:
Consolas;color:#FF8000;background:black'>object</span><span style='font-size:
12.0pt;font-family:Consolas;color:white;background:black'>[] { </span><span
style='font-size:12.0pt;font-family:Consolas;color:lime;background:black'>&quot;TLP.fdb&quot;</span><span
style='font-size:12.0pt;font-family:Consolas;color:white;background:black'> }),</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal'><span style='font-size:12.0pt;font-family:Consolas;color:white;
background:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span style='font-size:12.0pt;font-family:Consolas;color:#FF8000;
background:black'>new</span><span style='font-size:12.0pt;font-family:Consolas;
color:white;background:black'> </span><span style='font-size:12.0pt;font-family:
Consolas;color:yellow;background:black'>BackendStartupParameter</span><span
style='font-size:12.0pt;font-family:Consolas;color:white;background:black'>(</span><span
style='font-size:12.0pt;font-family:Consolas;color:#2B91AF;background:black'>FDOBackendProviderType</span><span
style='font-size:12.0pt;font-family:Consolas;color:white;background:black'>.kFirebirdClientServer,
</span><span style='font-size:12.0pt;font-family:Consolas;color:#2B91AF;
background:black'>BackendBulkLoadDomain</span><span style='font-size:12.0pt;
font-family:Consolas;color:white;background:black'>.All,</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal'><span style='font-size:12.0pt;font-family:Consolas;color:white;
background:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span style='font-size:12.0pt;font-family:Consolas;color:#FF8000;
background:black'>new</span><span style='font-size:12.0pt;font-family:Consolas;
color:white;background:black'> </span><span style='font-size:12.0pt;font-family:
Consolas;color:#FF8000;background:black'>object</span><span style='font-size:
12.0pt;font-family:Consolas;color:white;background:black'>[] { </span><span
style='font-size:12.0pt;font-family:Consolas;color:yellow;background:black'>Path</span><span
style='font-size:12.0pt;font-family:Consolas;color:white;background:black'>.Combine(</span><span
style='font-size:12.0pt;font-family:Consolas;color:yellow;background:black'>Path</span><span
style='font-size:12.0pt;font-family:Consolas;color:white;background:black'>.GetDirectoryName(</span><span
style='font-size:12.0pt;font-family:Consolas;color:yellow;background:black'>Assembly</span><span
style='font-size:12.0pt;font-family:Consolas;color:white;background:black'>.GetExecutingAssembly().CodeBase.Substring(8)),</span></p>

<p class=MsoNormal style='line-height:normal'><span style='font-size:12.0pt;
font-family:Consolas;color:white;background:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span style='font-size:12.0pt;font-family:Consolas;color:lime;
background:black'>&quot;TLP.csfdb&quot;</span><span style='font-size:12.0pt;
font-family:Consolas;color:white;background:black'>) }),</span></p>

<p class=MsoNormal>and</p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal'><span style='font-size:12.0pt;font-family:Consolas;color:white;
background:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span style='font-size:12.0pt;font-family:Consolas;color:#FF8000;
background:black'>new</span><span style='font-size:12.0pt;font-family:Consolas;
color:white;background:black'> </span><span style='font-size:12.0pt;font-family:
Consolas;color:yellow;background:black'>BackendStartupParameter</span><span
style='font-size:12.0pt;font-family:Consolas;color:white;background:black'>(</span><span
style='font-size:12.0pt;font-family:Consolas;color:#2B91AF;background:black'>FDOBackendProviderType</span><span
style='font-size:12.0pt;font-family:Consolas;color:white;background:black'>.kFirebirdEmbedded,
</span><span style='font-size:12.0pt;font-family:Consolas;color:#2B91AF;
background:black'>BackendBulkLoadDomain</span><span style='font-size:12.0pt;
font-family:Consolas;color:white;background:black'>.All,</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal'><span style='font-size:12.0pt;font-family:Consolas;color:white;
background:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span style='font-size:12.0pt;font-family:Consolas;color:#FF8000;
background:black'>new</span><span style='font-size:12.0pt;font-family:Consolas;
color:white;background:black'> </span><span style='font-size:12.0pt;font-family:
Consolas;color:#FF8000;background:black'>object</span><span style='font-size:
12.0pt;font-family:Consolas;color:white;background:black'>[] { </span><span
style='font-size:12.0pt;font-family:Consolas;color:lime;background:black'>&quot;TLP_New.fdb&quot;</span><span
style='font-size:12.0pt;font-family:Consolas;color:white;background:black'> }),</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal'><span style='font-size:12.0pt;font-family:Consolas;color:white;
background:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span style='font-size:12.0pt;font-family:Consolas;color:#FF8000;
background:black'>new</span><span style='font-size:12.0pt;font-family:Consolas;
color:white;background:black'> </span><span style='font-size:12.0pt;font-family:
Consolas;color:yellow;background:black'>BackendStartupParameter</span><span
style='font-size:12.0pt;font-family:Consolas;color:white;background:black'>(</span><span
style='font-size:12.0pt;font-family:Consolas;color:#2B91AF;background:black'>FDOBackendProviderType</span><span
style='font-size:12.0pt;font-family:Consolas;color:white;background:black'>.kFirebirdClientServer,
</span><span style='font-size:12.0pt;font-family:Consolas;color:#2B91AF;
background:black'>BackendBulkLoadDomain</span><span style='font-size:12.0pt;
font-family:Consolas;color:white;background:black'>.All,</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal'><span style='font-size:12.0pt;font-family:Consolas;color:white;
background:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span style='font-size:12.0pt;font-family:Consolas;color:#FF8000;
background:black'>new</span><span style='font-size:12.0pt;font-family:Consolas;
color:white;background:black'> </span><span style='font-size:12.0pt;font-family:
Consolas;color:#FF8000;background:black'>object</span><span style='font-size:
12.0pt;font-family:Consolas;color:white;background:black'>[] { </span><span
style='font-size:12.0pt;font-family:Consolas;color:yellow;background:black'>Path</span><span
style='font-size:12.0pt;font-family:Consolas;color:white;background:black'>.Combine(</span><span
style='font-size:12.0pt;font-family:Consolas;color:yellow;background:black'>Path</span><span
style='font-size:12.0pt;font-family:Consolas;color:white;background:black'>.GetDirectoryName(</span><span
style='font-size:12.0pt;font-family:Consolas;color:yellow;background:black'>Assembly</span><span
style='font-size:12.0pt;font-family:Consolas;color:white;background:black'>.GetExecutingAssembly().CodeBase.Substring(8)),</span></p>

<p class=MsoNormal style='line-height:normal'><span style='font-size:12.0pt;
font-family:Consolas;color:white;background:black'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span style='font-size:12.0pt;font-family:Consolas;color:lime;
background:black'>&quot;TLP_New.csfdb&quot;</span><span style='font-size:12.0pt;
font-family:Consolas;color:white;background:black'>) }),</span></p>

<p class=MsoNormal>[NB: the filename must be (read: it is imperative that)
unique to all other BEP DB names. The test suite deletes the files when the
test fixture is setup, and creates them <i>ex-nihilo</i> before the tests are
run. To distinguish the embedded vs. client-server Firebird files, I prepend
‘cs’ to the file extension for the client-server Firebird file.]</p>

<h2><a name="_Toc238450091">3.2<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Unit Of Work</a></h2>

<p class=MsoNormal>Any code that initiates data changes must (read: it is
imperative that) start a UOW and end the UOW, when the change is complete.
Failure to do this will result in an exception being thrown by the UOW
management system. The way to start a UOW is to call either of these two
methods on the ISilDataAccess interface implementation: BeginUndoTask or
BeginNonUndoableTask. The UOW is ended by calling the corresponding method:
EndUndoTask or EndNonUndoableTask.</p>

<p class=MsoNormal>The UOW system is set up as a Finite State Machine (FSM),
which means that certain activities are supported when the FSM is in certain
states, but not when it is other states. For instance, data changes may be not
be done, before starting a UOW, as the ‘waiting’ state does not allow such
changes. Once the UOW has been started, the state is changed to allow for one
or more data changes (create/delete/modify) for one or more CmObject instances.
During this state, no BeginUndoTask class can be made (i.e., currently, there
is no support for nested UOWs). Likewise, there can be no calls to Commit the
UOW, nor can there be attempts to broadcast the data changes to say the display
code.</p>

<p class=MsoNormal>When the EndUndoTask or the EndNonUndoableTask methods are
called, the state again changes to a state where the data changes are broadcast
to clients such as the display. This is done by calling the PropChanged method
on all registered IVwNotifyChange. No additional data changes are allowed in
this state, and any attempt to do so, will result in an exception being thrown.</p>

<p class=MsoNormal>I don’t yet have a distinct state set up for the Commit
phase of the UOW’s life, but I’m thinking about adding one. For now, a commit
cannot be done, except after the UOW is complete (i.e., after the EndUndoTask
method is called. Commit is automatically done at the end of the
EndNonUndoableTask.</p>

<p class=MsoNormal>There is no access to an actual UOW object other than by the
UOW management class. The CmObjects themselves do not have this access, but
they work through the manager class to register their comings, goings, and
modifications. When such registration is done, one of several special
IUndoAction classes is created and automatically added to the UOW’s collection
of IUndoActions.</p>

<p class=MsoNormal>‘Outsiders’ can add their own IUndoActions, if they wish,
but those should relate to issues that are not actual data changes. For
instance, one could add a special IUndoaction class to mange undo/redo of a
selection, or some other application level action.</p>

<p class=MsoNormal>There is no formal public access to the UOW manager class,
even though it currently is exposed via the IActionHandler interface it
implements. Casting that manager class to its C# class cannot be prevented, but
the UOW support methods are internal, so there is no reason to do the cast.
Indeed, the current support methods are going to change, once the design is
resolved on the ‘events/side effects’ matter.</p>

<p class=MsoNormal>There are two UOW helper classes that are designed to aide
client code in ensuring a UOW is started and ended properly:
UndoableUnitOfWorkHelper and NonUndoableUnitOfWorkHelper. These helper classes
will make the pair of calls to the respective Begin and End task methods. Both
of these are disposable, so the preferred way to use them is in ‘using’ code.
By default, both of these classes call Rollback on the UOW, if there is an
unhandled exception of any kind, during the UOW processing. (This ensures the
“A” in the ACID property all transactions are to support.) The last thing in
the ‘using’ block should be:</p>

<p class=MsoNormal>Helper.RollBack = false;</p>

<p class=MsoNormal>The Dispose method checks that Rollback Boolean. If it is
‘true’ (default value), then a Rollback is done. If it is ‘false’, then the
respective End task method is called.</p>

<p class=MsoNormal>At the moment, the data is not persisted at the end of a
UOW. The design for that is still pending.</p>

<p class=MsoNormal>Implications:</p>

<p class=MsoNormal>Code wrapped in “using new UndoTaskHelper” at least needs to
change to use UndoableUnitOfWorkHelper and to set Helper.Rollback = false at
the end of all success paths.</p>

<p class=MsoNormal>If such code is also called as part of a larger UOW, it
needs to be split into two methods: the core task (code inside the “using”
block), which can be shared with the larger task (and independently tested!),
and the original method which implements a stand-alone task, and typically does
nothing but wrap the core method in a UOW.</p>

<p class=MsoNormal>If such code is creating a custom UndoAction to more
efficiently record the changes, that behavior should go away. Hopefully the new
code is enough more efficient to make it unnecessary. If that proves not to be
the case, we may have to re-introduce this capability in selected cases.</p>

<p class=MsoNormal>Likewise, any direct calls to PropChanged should go away.
These are common after creating objects, since the old code did not do this
automatically. (The reason for this was to prevent a PropChanged inserting the
new object before it is initialized. The new UOW will delay the automatic propchanged
until the UOW is complete, and also suppress PropChanged calls for properties
of new objects, since they can’t be previously displayed anywhere.)</p>

<p class=MsoNormal>If a data change is being made in response to PropChanged,
this should now instead be done by implementing or modifying&nbsp;
XChangedSideEffects methods for the relevant classes.</p>

<h2><a name="_Toc238450092">3.3<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>IdentityMap</a></h2>

<p class=MsoNormal>The IdentityMap pattern is used in the new architecture to
ensure that only one instance of any given CmObject is in memory for any given
DB connection. The implementation class of the pattern is called IdentityMap,
of course. This class is internal and sealed. Since it is sealed, there are to
be no subclasses. Since it is internal, no code outside of the FDO assembly has
access to it. Most authorized users are in the persistence/repository systems
and the UOW system. There are a couple of other users, but they could be
refactored to not use it.</p>

<h2><a name="_Toc238450093">3.4<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Undo/Redo</a></h2>

<p class=MsoNormal>Undo &amp; Redo are pretty much normal. About the only
difference is that when a non-undoable UOW is started, then all prior UOWs are
persisted, and the undo &amp; redo stacks are cleared. A non-undoable UOW is
then persisted automatically at its end. The user cannot undo it, of course.</p>

<p class=MsoNormal>I covered it in the UOW section, but it bears restating
here, as well. Client code can add IUndoAction instances, and these will be
included in Undo and Redo calls. These IUndoActions should not be for actual
data changes, since those are all handled by FDO. They could be for a case of a
selection being undone/redone, for example.</p>

<h2><a name="_Toc238450094">3.5<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Metadata Cache (IFwMetaDataCacheManaged : IFwMetaDataCache)</a></h2>

<p class=MsoNormal>The main metadata cache (MDC)) implements the new
IFwMetaDataCacheManaged interface, which is a C# ‘extended’ version of the base
C++ IFwMetaDataCache interface. This extended interface includes everything
from the base interface, plus some .Net-friendly methods that avoid some of the
more unpleasant C++ method calls. Take this extension method, for example:</p>

<p class=MsoNormal style='line-height:normal'><span style='font-size:12.0pt;
font-family:Consolas;color:#FF8000;background:black'>uint</span><span
style='font-size:12.0pt;font-family:Consolas;color:white;background:black'>[]
GetFields(</span><span style='font-size:12.0pt;font-family:Consolas;color:#FF8000;
background:black'>uint</span><span style='font-size:12.0pt;font-family:"Times New Roman","serif";
color:white;background:black'> </span><span style='font-size:12.0pt;font-family:
Consolas;color:white;background:black'>clid, </span><span style='font-size:
12.0pt;font-family:Consolas;color:#FF8000;background:black'>bool</span><span
style='font-size:12.0pt;font-family:"Times New Roman","serif";color:white;
background:black'> </span><span style='font-size:12.0pt;font-family:Consolas;
color:white;background:black'>includeSuperclasses, </span><span
style='font-size:12.0pt;font-family:Consolas;color:#FF8000;background:black'>int</span><span
style='font-size:12.0pt;font-family:"Times New Roman","serif";color:white;
background:black'> </span><span style='font-size:12.0pt;font-family:Consolas;
color:white;background:black'>fieldTypes)</span></p>

<p class=MsoNormal>This extension method avoids having to use the AttrayPtr and
asking twice for the fields.</p>

<p class=MsoNormal>The extended interface is available publicly, but the C++
code that expects to get the original interface is also happy.</p>

<p class=MsoNormal>NB: The MDC currently uses uints, but FWR-32 calls for them
to be changed to ints for both the flids and clsids by the RC1 version of the
FW 7.0.</p>

<h2><a name="_Toc238450095">3.6<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>DomainDataByFlid (ISILDataAccessManaged : ISILDataAccess)</a></h2>

<p class=MsoNormal style='line-height:normal'><span style='font-size:12.0pt;
font-family:"Times New Roman","serif"'>This class is not an actual cache as is
found in FW 6.0. Rather, it is a Façade over the domain model’s CmObjects. The
primary client is the Views code, but other code can profitably use it as well.
Any code that works with objects and only knows about the object’s HVOs, guids,
or flids is a good candidate for using the interface.</span></p>

<p class=MsoNormal style='line-height:normal'><span style='font-size:12.0pt;
font-family:"Times New Roman","serif"'>A fair bit of the current client code
that uses the ISILDataAccess interface could better use the CmObjects, and not
continue to use the interface. The</span> <span class=MsoHyperlink><span
style='color:#00B0F0'>Upgrading</span></span><span style='color:#00B0F0'>
Issues</span><span style='color:#00B0F0'> </span>section goes into more details
on how to convert form the interface to the FDO objects.</p>

<p class=MsoNormal>Please note that the ISILDataAccess interface has also been
extended, as was done for the metadata cache interface. The reasons for
extending this interface are the same as for the other one: to be more .Net
friendly. A sample (actually, the only one, so far) extended method is:</p>

<p class=MsoNormal><span style='font-size:12.0pt;line-height:115%;font-family:
Consolas;color:#FF8000;background:black'>int</span><span style='font-size:12.0pt;
line-height:115%;font-family:Consolas;color:white;background:black'>[] VecProp(</span><span
style='font-size:12.0pt;line-height:115%;font-family:Consolas;color:#FF8000;
background:black'>int</span><span style='font-size:12.0pt;line-height:115%;
font-family:Consolas;color:white;background:black'> hvo, </span><span
style='font-size:12.0pt;line-height:115%;font-family:Consolas;color:#FF8000;
background:black'>int</span><span style='font-size:12.0pt;line-height:115%;
font-family:Consolas;color:white;background:black'> tag);</span></p>

<h2><a name="_Toc238450096">3.7<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Decorators (Metadata cache &amp; DomainDataByFlid)</a></h2>

<p class=MsoNormal>The new system provides a way to extend the support for the
model properties (model-defined or virtual) that is found on the standard
implementations of the two interfaces: IFwMetaDataCacheManaged and
ISILDataAccessManaged. There is an abstract decorator base class for each of
these two interfaces, which has most methods implemented to simply pass through
to the main FDO interface implementation classes. Classes derived from these
abstract base classes can then intercept select method calls to work with
classes and properties that are not supported by the domain layer and its
model. The overrides can then pass on to calls the main implementations, if the
‘stuff’ is not of interest.</p>

<p class=MsoNormal>A data access decorator would be used by the views code, for
example. A meta data cache decorator would then be used by the data access
decorator, since the fake hvos and fluids they both use are closely related.</p>

<p class=MsoNormal>These decorators should be used in situations where in the
FW 6.0 system one would add certain kinds of virtual properties to the FDO
classes.</p>

<p class=MsoNormal>For instance, there is a checkbox on each row in some browse
views in Flex. In FW 6.0 that was implemented as an add-on model property and
smarts were added to support that. The downside of this is that the browse
views were not independent, so all browse views showed the same items selected.
By using decorators to intercept those UI-related properties, such views can
independently show the same object as checked and unchecked. Whether some
property is currently available to show in multiple windows, or not, these
non-model properties are the best way to extend the model with properties that
are only interesting to one client.</p>

<p class=MsoNormal>Note that, because such properties exist only in the
decorator, they have meaning only in the one view (or just possibly a couple of
views) that use that decorator as their DataAccess. Changes to them should not
be broadcast to all views, and in fact (since the properties are not known to
the UOW, which is now responsible for all such broadcasts) there is no way to
do so. Therefore, changes to them should not be notified by calling PropChanged
on the main ISilDataAccess façade; indeed, that method is now unsupported
(throws NotSupportedException) and will eventually be removed. Instead, send
the notification of a change to a decorator property directly to the views it
serves. (Of course, if you want to build your own mechanism in the decorator to
keep track of the views that it serves and notify all of them when a decorator
property changes, that’s fine. Just don’t call PropChanged on the main
ISilDataAccess you are decorating.)</p>

<p class=MsoNormal>The way this might work in practice is there would be a pair
of decorators (MDC and SDA), although one might be able to get by without the
MDC decorator, as long as nobody tried to ask the main MDC for information
about the ‘private’ properties. The SDA client code (i.e., views code) would tell
its SDA (the decorator SDA) about some data change. That SDA could actually
cache its private property information, of calculate it, on the fly, whatever
it deemed best to do. (Indeed, it could even use the IVwCacheDa code to stuff
information into its own cache.) That SDA could then fire off the PropChanged
calls to clients it knew needed to know about the changes to its private
properties. The main SDA façade and the UOW need never know about it at all.</p>

<p class=MsoNormal>Another big use case for decorators is in filters. Assuming
the view is showing some made up ‘property’ of filtered objects; the decorators
can show different filtered sets of data in separate windows.</p>

<p class=MsoNormal>I think now that back references are not generally part of
the object model, another big user of decorators will be for the back ref
properties. The ISILDataAccess decorator can then fetch the desired objects
from a Repository</p>

<h2><a name="_Toc238450097">3.8<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Repositories</a></h2>

<p class=MsoNormal>Repositories are interesting in that the interfaces for them
are defined within the domain layer. Their implementations, however, are
considered to be in the infrastructure layer, since they connect with the data
store and talk to it. The Repositories are not currently in the Infrastructure
namespace, but that is where they really belong. I suppose I ought to fix that
pretty soon, no? :-)</p>

<h1><a name="_Toc238450098"></a><a name="_Ref234491101"></a><a
name="_Ref234491081"></a><a name="_Ref234491055">4<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Upgrading Issues</a></h1>

<p class=MsoNormal>This section will cover issues developers will run into
trying to use the new FDO system, as well as upgrading other assemblies, during
the re-architecture effort.</p>

<h2><a name="_Toc238450099">4.1<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Applications</a></h2>

<p class=MsoNormal>I suggest that each application have a bare-bones minimal
version that shows nothing, perhaps not even menus or toolbars. I know Flex is
already in this condition, and that some efforts have been made to get TE to
start. When the minimalist feature set is defined for each application, that
can be made to work in the new architecture, and the rest of the code left out
of the build, or defined out using #if WANTPORT. After that is working, that
near braindead version can be sent off to India and tested.</p>

<p class=MsoNormal>Then, another ‘version’ and feature set can be defined, and
the code made to get it to work. When it works, it can also be made available
for testing. This cycle can be repeated, until each application is working
fully. The key idea is to get code in the various assemblies to work for that
limited feature set, and block out other code, temporarily.</p>

<p class=MsoNormal>I also suggest that when considering what to include in the
very early ‘versions’ of each application that potential blocker-type cases be
done early. That way, one can bail out of the rearchitecture effort on some
unforeseen fatal issue.</p>

<h3><a name="_Toc238450100">4.1.1<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Flex</a></h3>

<p class=MsoNormal>The ‘early’ version of Flex will include these features: x,
y, &amp; z.</p>

<h3><a name="_Toc238450101">4.1.2<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>TE</a></h3>

<p class=MsoNormal>The ‘early’ version of TE will include these features: x, y,
&amp; z.</p>

<h3><a name="_Toc238450102">4.1.3<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Data Notebook</a></h3>

<p class=MsoNormal>Since this program is all written in C++, it will have to
redone in C#. It will be redone using Flex technology, and reside in Flex. Some
features may be modified or even omitted, as long as data is not lost.</p>

<p class=MsoNormal>The ‘early’ version of Data Notebook will include these
features: x, y, &amp; z.</p>

<h3><a name="_Toc238450103">4.1.4<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>List Editor</a></h3>

<p class=MsoNormal>Since this program is all written in C++, it will have to
redone in C#. It will be redone using Flex technology, and each application
will have its own list editor area(s) to edit the lists it cares about. Most of
this already exists, but there are a few lists and some list-editor behaviors,
particularly related to creating new custom lists, that are not yet supported.</p>

<p class=MsoNormal>The ‘early’ version of List Editor will include these
features: x, y, &amp; z.</p>

<h2><a name="_Toc238450104">4.2<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Common Upgrade issues</a></h2>

<h3><a name="_Toc238450105">4.2.1<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>ISILDataAccess vs. CmObject use</a></h3>

<p class=MsoNormal>Since the old data cache (ISILDataAccess, or SDA) is no
longer a cache, but rather a Façade over FDO, code that currently accesses the
data via the SDA needs thought about how to treat it. Code, such as the Views
code, or FXT, that has no knowledge of the object and properties it is working
with, and must, therefore, be very general, ought to continue to use the SDA
interface to access the data. In cases where the original code does know what
objects it has and the desired properties it is interested in, but has merely
used SDA to not have to create a CmObject instance, probably ought to switch to
use the CmObject. It will be faster to use the CmObject. If one only has the
HVO of the interesting object, it can be fetched from the relevant Repository
and used. Or, perhaps the code can be revised to pass the CmObject around, and
not it’s HVO. Upgrading code to pass, and use, the CmObject will be better in
the end, as client code need not fetch it from a Repository.</p>

<p class=MsoNormal>&nbsp;</p>

<h2><a name="_Toc238450106">4.3<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>FDO code</a></h2>

<h3><a name="_Toc238450107">4.3.1<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Repositories</a></h3>

<p class=MsoNormal>Client code that used the constructor with the FdoCache and
an hvo int <i>must</i> now use another mechanism to get an extant CmObject. One
good option is the Repository for the class of object that is sought. If one
does not know what its class is, then use the ICmObjectRepository.</p>

<h3><a name="_Toc238450108">4.3.2<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Factories</a></h3>

<p class=MsoNormal>Client code should be switched to use the new Factories,
rather than continue to use constructors.</p>

<h3><a name="_Toc238450109">4.3.3<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Obsolete namespaces in FDO</a></h3>

<p class=MsoNormal>The old namespaces that corresponded to the FDO modules have
been removed. Files that still have them in ‘using’ will need to remove them.</p>

<h3><a name="_Toc238450110">4.3.4<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>FdoCache</a></h3>

<p class=MsoNormal>Many of the old methods on FdoCache have been removed, since
they belonged elsewhere. One needs to look ‘elsewhere’ in the proper home for
these methods. For instance, the various ‘helper’ methods for the metadata
cache (MDC) have been removed. One can just use the MDC instead, which now has
some C#-friendly methods.</p>

<p class=MsoNormal>To get at the MDC, LangProject, or other big items, one can
continue toi use FdoCache to get at them. One can get them from the Service
Locator, as well, which is what the FdoCache does now anyway.</p>

<h3><a name="_Toc238450111">4.3.5<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>FDO Vector classes</a></h3>

<p class=MsoNormal>One big difference between the FW 6.0 vector classes and the
new classes is that the new one does not support code such as:</p>

<p class=MsoNormal>var newFoo = bar.collProp.Add(new Foo());</p>

<p class=MsoNormal>The code to do this in the new system would be:</p>

<p class=MsoNormal>var newFoo = fooFactory.Create();<br>
bar.collProp.Add(newFoo);</p>

<p class=MsoNormal>This is because the new system uses the standard .Net
collection and list interfaces, which do not return what was added.</p>

<p class=MsoNormal>There is also no Append(foo) method, since that is not part
of the .Net interfaces. Add(foo) should be used rather than Append(foo).</p>

<p class=MsoNormal>The old HvoArray property needs to be redone to use the
ToHvoArray() method. This was done to keep the symmetry with the ToArray()
method.</p>

<p class=MsoNormal>The ‘FirstItem’ property of the vectors is not implemented
in the new system. One can use [0] to get the first object in a sequence, and
collections have no ordering, so getting the ‘first’ one is meaningless. One
can also use LINQ-Objects to do this with its ‘FirstOrDefault’ mechanism, but
that still won’t give any meaning to the first object in an unordered
collection.</p>

<h3><a name="_Toc238450112">4.3.6<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>FDO MultiString &amp; MultiUnicode classes</a></h3>

<p class=MsoNormal>For upgrading extant code, one can remove calls to now
obsolete methods or properties, such as “UnderlyingTsString” for the
multi-unicode string collections. Both MultiString and MultiUnicode classes
return only the underlying ITsString. In some cases that assumed the C# string
was being returned, one needs to add “.Text” to get it from the returned
ITsString.</p>

<h3><a name="_Toc238450113">4.3.7<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Virtual Property Handler class &amp; related interface</a></h3>

<p class=MsoNormal>The old FW 6.0 IVwVirtualhandler interface and all of its
implementation classes are obsolete and not to be kept in the new system. The
new system handles this differently.</p>

<p class=MsoNormal>For ‘virtual’ properties that need to be accessed by the
ISILDataAccess Façade, one needs to add a special attribute to the property.
This new attribute is of the class “VirtualPropertyAttribute”, which is a
subclass of the .Net Attribute class. Properties marked with this attribute are
added to the metadata cache. If one need not access a property with the SDA,
then this attribute ought not be used. That is a simple property of the sort
that can be on any .Net object.</p>

<p class=MsoNormal>Here are some typical steps (the example is the virtual
property ILexSense.LexSenseOutline).</p>

<p class=MsoListParagraph style='text-indent:-.25in'>1.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Add an appropriate method to the interface, e.g., in ILexSense partial
class in FDO/FdoInterfaceAdditions.cs add</p>

<p class=MsoNormal>ITsString LexSenseOutline { get; }</p>

<p class=MsoListParagraph style='text-indent:-.25in'>2.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Add an implementation, e.g., in class LexSense of
FDO/DomainImpl/OverridesLing_Lex.cs</p>

<p class=CodeCxSpFirst>       public ITsString LexSenseOutline</p>

<p class=CodeCxSpMiddle>       {</p>

<p class=CodeCxSpMiddle>           get</p>

<p class=CodeCxSpMiddle>           {</p>

<p class=CodeCxSpMiddle>               string outline =
m_cache.GetOutlineNumber(this, LexSenseTags.kflidSenses, false, true);</p>

<p class=CodeCxSpMiddle>               return m_cache.MakeUserTss(outline);</p>

<p class=CodeCxSpMiddle>           }</p>

<p class=CodeCxSpLast>       }</p>

<p class=MsoListParagraph style='text-indent:-.25in'>3.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Mark it as a virtual property, e.g., right before the method put</p>

<p class=Code>[VirtualProperty(CellarModuleDefns.kcptString)]</p>

<p class=MsoNormal style='margin-left:.25in'>(If it's an object property it
should have as a second argument a signature, a string giving the unqualified
class name, e.g., “LexEntry”.)</p>

<p class=MsoListParagraph style='text-indent:-.25in'>4.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Implement or modify side effect methods to send notifications if something
changes that would affect it,e.g., </p>

<p class=CodeCxSpFirst style='margin-left:0in'>        protected override void
AddObjectSideEffectsInternal(AddObjectEventArgs e)</p>

<p class=CodeCxSpMiddle style='margin-left:0in'>        {</p>

<p class=CodeCxSpMiddle style='margin-left:0in'>            if (e.Flid ==
LexSenseTags.kflidSenses)</p>

<p class=CodeCxSpMiddle style='margin-left:0in'>            {</p>

<p class=CodeCxSpMiddle style='margin-left:0in'>                // The virtual
property LexSenseOutline may be changed for the inserted </p>

<p class=CodeCxSpMiddle style='margin-left:0in'>                // sense and
all its following senses and their subsenses.</p>

<p class=CodeCxSpMiddle style='margin-left:0in'>               
SensesChangedPosition(e.Index);</p>

<p class=CodeCxSpMiddle style='margin-left:0in'>            }</p>

<p class=CodeCxSpMiddle style='margin-left:0in'>           
base.AddObjectSideEffectsInternal(e);</p>

<p class=CodeCxSpLast style='margin-left:0in'>        }</p>

<p class=MsoNormal style='margin-left:.25in'>After a few intermediates, this
calls</p>

<p class=CodeCxSpFirst style='margin-left:0in'>        internal void
LexSenseOutlineChanged()</p>

<p class=CodeCxSpMiddle style='margin-left:0in'>        {</p>

<p class=CodeCxSpMiddle style='margin-left:0in'>            uint flid =
m_cache.MetaDataCache.GetFieldId2(LexSenseTags.kClassId,</p>

<p class=CodeCxSpMiddle style='margin-left:.5in;text-indent:.25in'>&quot;LexSenseOutline&quot;,
false);</p>

<p class=CodeCxSpMiddle style='margin-left:0in'>            ITsString
tssOutline = LexSenseOutline;</p>

<p class=CodeCxSpMiddle style='margin-left:0in'>            // We can't get a
true old value, but a string the same length with different </p>

<p class=CodeCxSpMiddle style='margin-left:0in'>            // characters
should cause the appropriate display updating. Pathologically, </p>

<p class=CodeCxSpMiddle>        // the old value might differ in length; if
that causes a problem at some point, </p>

<p class=CodeCxSpMiddle style='margin-left:0in'>            // we'll have to deal
with it.</p>

<p class=CodeCxSpMiddle style='margin-left:0in'>            ITsStrBldr bldr =
tssOutline.GetBldr();</p>

<p class=CodeCxSpMiddle style='margin-left:0in'>            StringBuilder sb =
new StringBuilder(bldr.Length);</p>

<p class=CodeCxSpMiddle style='margin-left:0in'>            sb.Append(' ',
bldr.Length);</p>

<p class=CodeCxSpMiddle style='margin-left:0in'>            bldr.Replace(0,
bldr.Length, sb.ToString(), null);</p>

<p class=CodeCxSpMiddle style='margin-left:0in'>           
((FdoMediator)m_cache.ServiceLocator.GetInstance&lt;IActionHandler&gt;()).</p>

<p class=CodeCxSpMiddle style='margin-left:.5in'>     RegisterVirtualAsModified(this,
flid, bldr.GetString(), tssOutline);</p>

<p class=CodeCxSpMiddle style='margin-left:0in'>            foreach (LexSense
sense in SensesOS)</p>

<p class=CodeCxSpMiddle style='margin-left:0in'>               
sense.LexSenseOutlineChanged();</p>

<p class=CodeCxSpLast style='margin-left:0in'>        }</p>

<p class=MsoNormal>Note the use of the MetaDataCache to get the appropriate
flid, and the call to RegisterVirtualAsModified; this eventually causes the
PropChanged.</p>

<p class=MsoNormal>With virtual properties it is often difficult to obtain an
accurate old value. For string properties the old value is not critical. For
object properties, if you are not entirely sure of the correct old value pass
an empty collection; this may be less efficient but should always give the
right display. (But will Undo?)</p>

<p class=MsoNormal>You may need to make new overloads of RegisterVirtualAsModified,
only simple TsString properties are supported as yet. In general each
RegisterObjectAsModified method (there is one for each type of property) may
eventually need a corresponding overload of RegisterVirtualAsModified; this
will typically create a new subclass of the class which
RegisterObjectAsModified creates, and passing it to RegisterCommon. The
subclass will override Undo and Redo to do nothing, and IsDataChange to answer
false.</p>

<h3><a name="_Toc238450114">4.3.8<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Obsolete methods</a></h3>

<p class=MsoNormal style='line-height:normal'><span style='font-size:12.0pt;
font-family:"Times New Roman","serif"'>There are a variety of obsolete methods
scattered around in the FDO assembly. They should not be re-implemented, but
rather the proper method should be used.</span></p>

<p class=MsoNormal style='line-height:normal'><span style='font-size:12.0pt;
font-family:"Times New Roman","serif"'>One method that need not be updated is
the “IsRealObject” method of FdoCache. All CmObjects are real, even if they
have been deleted, or haven’t been properly set up with valid Hvos yet. Calls
to the old IsRealObject method will have to be removed, since the code won’t
compile with it remaining</span>.</p>

<p class=MsoNormal><a></a><a></a><a><span class=msoDel><del
cite="mailto:SIL%20International" datetime="2009-07-16T11:27">Does this mean
all calls to IsRealObject should be deleted? Or s</del></span><span
class=msoIns><ins cite="mailto:SIL%20International" datetime="2009-07-16T11:27">S</ins></span>hould
some be changed to IsValidObject or something similar?</a><span
class=MsoCommentReference><span style='font-size:8.0pt;line-height:115%'><a
class=msocomanchor id="_anchor_2"
onmouseover="msoCommentShow('_anchor_2','_com_2')"
onmouseout="msoCommentHide('_com_2')" href="#_msocom_2" language=JavaScript
name="_msoanchor_2">[RBR2]</a>&nbsp;</span></span><span
class=MsoCommentReference><span style='font-size:8.0pt;line-height:115%'><a
class=msocomanchor id="_anchor_3"
onmouseover="msoCommentShow('_anchor_3','_com_3')"
onmouseout="msoCommentHide('_com_3')" href="#_msocom_3" language=JavaScript
name="_msoanchor_3">[JVT3]</a>&nbsp;</span></span><span
class=MsoCommentReference><span style='font-size:8.0pt;line-height:115%'><a
class=msocomanchor id="_anchor_4"
onmouseover="msoCommentShow('_anchor_4','_com_4')"
onmouseout="msoCommentHide('_com_4')" href="#_msocom_4" language=JavaScript
name="_msoanchor_4">[RBR4]</a>&nbsp;</span></span></p>

<p class=MsoNormal>&nbsp;</p>

<h3><a name="_Toc238450115">4.3.9<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Instance methods not found on some CmObject class</a></h3>

<p class=MsoNormal>Some public methods (not static methods) have not yet been
included in the interface, or perhaps they were in the interfaces, but have
simply not yet been ported yet.</p>

<p class=MsoNormal>One ought to consider if the method actually belongs on that
class, or if it might really belong elsewhere, before adding it to the
interface. For instance, a lot of previous static methods related to getting
writing systems are now living in the ILgWritingSystemRepository.</p>

<h3><a name="_Toc238450116">4.3.10<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span>IVwCacheDa interface</a></h3>

<p class=MsoNormal>The IVwCacheDa interface is not supported in FDO. It was
used in FW 6.0 to add data to the SDA cache, which avoided adding the data to
the DB. FDO has no need of the interface, since it handles all legitimate
domain data. Any data that might profitably go into this cache cannot be domain
data by definition. Clients that really insist on having a place to stuff such
data would be wise to use some C++ implementation that was disassociated from
persistence altogether, rather than try and add the capability to the FDO
system. Using the interface for that use case is perfectly fine.</p>

<h3><a name="_Toc238450117">4.3.11<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span>ScrFdo</a></h3>

<p class=MsoNormal>This assembly has been brought back into the main FDO
assembly, in theory. In practice, however, very little of the ScrFdo code has
actually been moved back at this point. Until the integrations from the trunk
die down to a trickle, it will be quite hard to ensure that the code in the old
ScrFdo assembly has been properly integrated into the main FDO assembly. I
recommend that when the ScrFdo code is finally moved into the FDO assembly,
that the old code be deleted in the original file, when the port is finished.
Then, it will be easy to spot what has yet to be ported.</p>

<h3><a name="_Toc238450118">4.3.12<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span>Porting assemblies</a></h3>

<p class=MsoNormal>In general, I suggest assemblies be upgraded, to support the
‘early’ versions of the apps, but code not needed yet, be left ‘as is’ or if it
fails to compile, then wrapped with #if WANTPORT #endif, until such time as it
is really needed and can be dealt with properly. Likewise, unit tests can be disabled
or wrapped the same way, until the code they test is needed.</p>

<h3><a name="_Toc238450119">4.3.13<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span>Unit tests</a></h3>

<p class=MsoNormal style='line-height:normal'><span style='font-size:12.0pt;
font-family:"Times New Roman","serif"'>All unit tests that need FDO should
derive from the base class “MemoryOnlyBackendProviderTestBase”. This base class
is set to use the memory only ‘data store’. Besides being faster than using a
real data store system, one need not fret about ensuring the data is correctly
restored after the tests are run, as is required with the FW 6.0 TestLangProj
data set. Since it is only in memory, it will be recycled nicely.</span></p>

<p class=MsoNormal style='line-height:normal'><span style='font-size:12.0pt;
font-family:"Times New Roman","serif"'>The memory only BEP is reset to its
pristine state during the base method call to “FixtureSetup()”. This is defined
on the base class for all FDO dependent tests “FdoTestBase”. You all will call
that base method if you override the method, right? :-)</span></p>

<p class=MsoNormal><a></a><a></a><a>What can one assume is in the memory-only
test database? Any writing systems? LangProject? Lexicon? Any possibility
lists? Are there helper functions to create commonly-useful sets of objects?</a><span
class=MsoCommentReference><span style='font-size:8.0pt;line-height:115%'><a
class=msocomanchor id="_anchor_5"
onmouseover="msoCommentShow('_anchor_5','_com_5')"
onmouseout="msoCommentHide('_com_5')" href="#_msocom_5" language=JavaScript
name="_msoanchor_5">[RBR5]</a>&nbsp;</span></span><span
class=MsoCommentReference><span style='font-size:8.0pt;line-height:115%'><a
class=msocomanchor id="_anchor_6"
onmouseover="msoCommentShow('_anchor_6','_com_6')"
onmouseout="msoCommentHide('_com_6')" href="#_msocom_6" language=JavaScript
name="_msoanchor_6">[JVT6]</a>&nbsp;</span></span><span
class=MsoCommentReference><span style='font-size:8.0pt;line-height:115%'><a
class=msocomanchor id="_anchor_7"
onmouseover="msoCommentShow('_anchor_7','_com_7')"
onmouseout="msoCommentHide('_com_7')" href="#_msocom_7" language=JavaScript
name="_msoanchor_7">[RBR7]</a>&nbsp;</span></span></p>

<p class=MsoNormal>Unit tests ought to test the System Under Test (SUT), and
only the SUT. One should assume systems the SUT uses have been tested
adequately. If they have not, then they should be. One can burn up a ton of
cycles checking things not a part of the SUT.</p>

<h3><a name="_Toc238450120">4.3.14<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span>What won’t work yet</a></h3>

<p class=MsoNormal>Paragraph-level text editing using Views won’t work yet (you
will get assertions when PropChanged is called directly).</p>

<p class=MsoNormal>Todo: anything else worth mentioning?</p>

<h2><a name="_Toc238450121">4.4<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>A Worked Example</a></h2>

<p class=MsoNormal>I thought it might be interesting to include here the steps
I (JohnT) went through in order to get the LexEdDll to build successfully. This
is roughly in chronological order.</p>

<h3><a name="_Toc238450122">4.4.1<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Fix FDO ‘using’ declarations</a></h3>

<p class=MsoNormal>Remove using declaration for obsolete FDO subdomains
(SIL.FieldWorks.FDO.Ling, etc.). You may need to add
SIL.FieldWorks.FDO.DomainImpl and/or SIL.FieldWorks .FDO.Infrastructure.</p>

<h3><a name="_Toc238450123">4.4.2<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Make everything use interfaces and Tags</a></h3>

<p class=MsoNormal>Change all references to FDO implementation classes to
interfaces, e.g., when it complains that LexEntry is undefined, change to
ILexEntry. (Do not add a namespace reference to allow continued use of
LexEntry; this won’t work much longer). Watch out for class names that match
property names; ReversalIndex, for example. You don’t want to add the “I” to
the property name.</p>

<p class=MsoNormal>Change sequences like ILexEntry.kclsidLexEntry to
LexEntryTags.kClassId. Across the whole project, with regular expressions,
replace “I{[^.]*}\.kclsid\1” with “\1Tags.kClassId”.</p>

<p class=MsoNormal>Also, things like (int)LexEntry.LexEntryTags become just
LexEntryTags; you can do this with a project-wide replace using regular
expressions, “\(int\)[^.]*\.{[^.]*Tags}” is replaced with “\1”.</p>

<h3><a name="_Toc238450124">4.4.3<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Undotasks/UnitOfWork</a></h3>

<p class=MsoNormal>Change things like:</p>

<p class=MsoNormal style='text-indent:.5in;line-height:normal'><span
style='font-size:12.0pt;font-family:"Times New Roman","serif"'>using (new
UndoRedoTaskHelper(m_obj.Cache, sUndo, sRedo)) {...}</span></p>

<p class=MsoNormal>to</p>

<p class=MsoNormal style='text-indent:.5in;line-height:normal'><span
style='font-size:12.0pt;font-family:"Times New Roman","serif"'>UndoableUnitOfWorkHelper.Do(sUndo,
sRedo, m_obj, () =&gt; {...}); </span></p>

<p class=MsoNormal>That is, the old code block becomes a delegate implemented
as a lambda expression.</p>

<p class=MsoNormal>Or, preferably, the contents of {...} should be a single
call to a zero argument method (Undo handling is a separate responsibility from
the task that can be Undone, and that separate task may be useful to include in
other tasks, too, whereas you cannot now nest undoable tasks). If so, </p>

<p class=MsoNormal style='text-indent:.5in;line-height:normal'><span
style='font-size:12.0pt;font-family:"Times New Roman","serif"'>using (new
UndoRedoTaskHelper(m_obj.Cache, sUndo, sRedo)) {DoTheTask();} </span></p>

<p class=MsoNormal>becomes</p>

<p class=MsoNormal style='text-indent:.5in;line-height:normal'><span
style='font-size:12.0pt;font-family:"Times New Roman","serif"'>UndoableUnitOfWorkHelper.Do(sUndo,
sRedo, m_obj, DoTheTask);</span></p>

<p class=MsoNormal>Note that there no parens after DoTheTask; you are passing a
delegate.</p>

<p class=MsoNormal>There’s also an approach using (var helper = new
UndoableUnitOfWorkHelper(…)), but you have to remember to set helper.RollBack
to false as the last step in your task; I think the Do approach is cleaner.</p>

<h3><a name="_Toc238450125">4.4.4<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Object Creation</a></h3>

<p class=MsoNormal>Object creation. Change things like</p>

<p class=MsoNormal style='line-height:normal'><span style='font-size:12.0pt;
font-family:"Times New Roman","serif"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
ILexEntryRef ler = new LexEntryRef();</span></p>

<p class=MsoNormal style='line-height:normal'><span style='font-size:12.0pt;
font-family:"Times New Roman","serif"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
ent.EntryRefsOS.Append(ler);</span></p>

<p class=MsoNormal>or</p>

<p class=MsoNormal style='line-height:normal'><span style='font-size:12.0pt;
font-family:"Times New Roman","serif"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
ILexEntryRef ler = ent.EntryRefsOS.Append(new LexEntryRef());</span></p>

<p class=MsoNormal>to </p>

<p class=MsoNormal style='line-height:normal'><span style='font-size:12.0pt;
font-family:"Times New Roman","serif"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;var ler = ent.Services.GetInstance&lt;ILexEntryRefFactory&gt;().Create();</span></p>

<p class=MsoNormal style='line-height:normal'><span style='font-size:12.0pt;
font-family:"Times New Roman","serif"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ent.EntryRefsOS.Add(ler);</span></p>

<p class=MsoNormal>(You don't absolutely have to change the type to 'var', it's
just nicer. You do have to make two lines of it; Add() does not return the
thing added. Note the change from Append to Add, as well as the more obvious
use of the factory.)</p>

<p class=MsoNormal>This is one of the things I don’t like much; there is a
discussion on the Wiki of possible alternative approaches to object creation.</p>

<p class=MsoNormal>In case you’re not appending, you’ll also need to deal with
the fact that InsertAt() has changed to Insert, and the arguments have swapped
(index comes first). Slightly painful, but puts us in line with other .NET
interfaces.</p>

<h3><a name="_Toc238450126">4.4.5<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Get rid of calls to PropChanged</a></h3>

<p class=MsoNormal>Commonly these are to inform the Views of newly added
objects; these can just be deleted, the new UOW is smart about sending them
AFTER you have initialized the objects.</p>

<p class=MsoNormal>(If they are to update the display of virtual properties you
have a harder problem. I didn’t come across one of these and haven’t entirely
figured out how to handle them.)</p>

<h3><a name="_Toc238450127">4.4.6<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Dealing with HVOs</a></h3>

<p class=MsoNormal>In many cases where you are passing HVOs to methods of
CmObject property collections and sequences you will need to pass instead a
CmObject. One way to get one (if you already have some other object) is with
anObj.Services.GetObject(hvo). Or if you have a cache,
cache.ServiceLocator.GetObject(hvo).</p>

<p class=MsoNormal>HvoArray (on our sequence property classes) becomes
ToHvoArray() (or consider whether the algorithm could be changed to use
objects).</p>

<p class=MsoNormal>Atomic properties ending in Hvo: insert dot, or (preferably)
do something equivalent using objects, e.g., affAllo.MsEnvPartOfSpeechRAHvo !=
0 becomes affAllo.MsEnvPartOfSpeechRA != null. (In this case
affAllo.MsEnvPartOfSpeechRA.Hvo != 0 won't work, because it will produce a null
reference exception).</p>

<h3><a name="_Toc238450128">4.4.7<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Implementations of PropChanged</a></h3>

<p class=MsoNormal>Commonly these are kludges to produce side effects in the
model. This should not be done! In fact it will no longer work; you can’t make
model changes in the UOW phase where PropChanged is sent.</p>

<p class=MsoNormal>Instead, if certain things ought always to change when
certain other things change, we now want to implement that domain logic in FDO
as part of the setters of the primary properties.</p>

<p class=MsoNormal>That may be a project…I haven’t entirely figured out yet how
to hook changes to object sequence properties. To get the thing to at least
compile quickly, you may block out the whole PropChanged method with #if
WANTPORT. You will typically also have to delete the code that says the class
implements IVwNotifyChange, and that adds and removes it from collection of
things that get such notifications.</p>

<h3><a name="_Toc238450129">4.4.8<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Writing systems and multistrings</a></h3>

<p class=MsoNormal>Writing system collections are found on the writing systems
repository, sometimes with somewhat different names. For example,
cache.LangProj.InstalledWritingSystems becomes cache.ServiceLocator.WritingSystems.AllInstances().</p>

<p class=MsoNormal>Some methods have also changed signatures, returning WS
objects or object collections rather than HVOs; add .Hvo or .ToHvoArray() or
the like, as needed.</p>

<p class=MsoNormal>Some values retrieved from multistring accessors require
.Text appended to convert from TsStrings to strings.</p>

<h3><a name="_Toc238450130">4.4.9<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Stuff on the implementation class</a></h3>

<p class=MsoNormal>Since the implementation classes (like LexEntry) are no
longer accessible, something must be done about their nested types and static
methods.</p>

<p class=MsoNormal>Enums may need to be moved to the Tags class. I had to do
this for LexRefTags.MappingTypes. This is stretching the responsibility of the
Tags classes; if someone has a better idea, speak up.</p>

<p class=MsoNormal>I stretched a point further and put a method on
LgWritingSystemTags that returns a fixed ITsTextProps. I like that even less
well. Ideas welcome.</p>

<h3><a name="_Toc238450131">4.4.10<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span>Valid objects, dummy objects, and the like</a></h3>

<p class=MsoNormal>Delete calls that check whether objects are real, or valid,
or dummy, or that attempt to convert dummies to real. All objects in the
current system are real. <a>I’m not 100% sure that we will never need to check
whether an object we still have a reference to represents something that has
been deleted, but for now, there’s no way to do it.</a><span
class=MsoCommentReference><span style='font-size:8.0pt;line-height:115%'><a
class=msocomanchor id="_anchor_8"
onmouseover="msoCommentShow('_anchor_8','_com_8')"
onmouseout="msoCommentHide('_com_8')" href="#_msocom_8" language=JavaScript
name="_msoanchor_8">[RBR8]</a>&nbsp;</span></span></p>

<h3><a name="_Toc238450132">4.4.11<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span>Working with flids</a></h3>

<p class=MsoNormal>If something really has to be done using flids, you can
retrieve the facade. For example, I changed this:</p>

<p class=MsoNormal style='text-indent:.5in;line-height:normal'><span
style='font-size:12.0pt;font-family:"Times New Roman","serif"'>return&nbsp;
obj.GetObjectInAtomicField(flid) as IFsFeatStruc;</span></p>

<p class=MsoNormal>to this:</p>

<p class=MsoNormal style='text-indent:.5in;line-height:normal'><span
style='font-size:12.0pt;font-family:"Times New Roman","serif"'>int hvoFs =
obj.Services.GetInstance&lt;ISilDataAccess&gt;().get_ObjectProp(obj.Hvo, flid);</span></p>

<p class=MsoNormal style='text-indent:.5in;line-height:normal'><span
style='font-size:12.0pt;font-family:"Times New Roman","serif"'>if (hvoFs == 0)</span></p>

<p class=MsoNormal style='line-height:normal'><span style='font-size:12.0pt;
font-family:"Times New Roman","serif"'>&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;return null;</span></p>

<p class=MsoNormal style='text-indent:.5in;line-height:normal'><span
style='font-size:12.0pt;font-family:"Times New Roman","serif"'>return obj.Services.GetObject(hvoFs)
as IFsFeatStruc;</span></p>

<p class=MsoNormal>(We could re-implement GetObjectInAtomicField, but we don't
want to encourage flid-based programming.)</p>

<h3><a name="_Toc238450133">4.4.12<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span>Vanished methods</a></h3>

<p class=MsoNormal>You may well find some methods being called which no longer
exist. Often you can find the old implementation in FDO in a file that isn’t
currently being built, or disabled by #if WANTPORT. If appropriate, you can fix
the implementation as needed and reinstate the method (also in the interface,
if you need it outside FDO).</p>

<h3><a name="_Toc238450134">4.4.13<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span>Wrapping up</a></h3>

<p class=MsoNormal>The last thing I did was to change LexText.build.xml to
reinstate LexEdDll into the dependencies of LexTextExe. I also removed
MorphologyEditorDll from the dependencies of LexEdDll, since I’d already
applied WANTPORT to the couple of things actually wanted from there. I noted
this in the build file as a reminder to put it back eventually if needed.</p>

<h1><a name="_Toc238450135">5<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Unit Test Framework</a></h1>

<p class=MsoNormal>The FDO unit test framework has been revised a good bit. The
test class hierarchy is:</p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt'>FdoTestBase
(abstract)</p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;text-indent:
.5in'>PersistingBackendProviderTestBase (abstract)</p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;text-indent:
.5in'>                (One class per embedded type BEP)</p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;text-indent:
.5in'>                PersistingClientServerBackendProviderTestBase (abstract)</p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;text-indent:
.5in'>                                (One class per client-server type BEP)</p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;text-indent:
.5in'>MemoryOnlyBackendProviderTestBase (abstract)</p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;text-indent:
.5in'>                (Many subclasses)</p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt'>(Various
classes that do not need FdoTestBase support)</p>

<h2><a name="_Toc238450136">5.1<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>FdoTestBase (abstract)</a></h2>

<p class=MsoNormal>I don’t see any more need at this point for more direct
subclasses of FdoTestBase.</p>

<h2><a name="_Toc238450137">5.2<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>PersistingBackendProviderTestBase (abstract)</a></h2>

<p class=MsoNormal>The PersistingBackendProviderTestBase serves as the location
where all tests are defined for testing the actual (de)serializing
capabilities  for each supported BEP. There is to be one subclass of
PersistingBackendProviderTestBase for each supported BEP, but that subclass does
not add any BEP specific tests. The reason for this is that most of the BEP’s
API is internal so cannot easily be directly tested. The idea of placing all
tests on PersistingBackendProviderTestBase is that one can then test the
affects of the internal API by dogin some action, remembering the state,
persisting the changes, restarting the BEP, and checking the persisted and
reloaded results against the remembered starting state. This will test all of
the internal API, but indirectly.</p>

<p class=MsoNormal>I see a need for one more new abstract subclass of
PersistingBackendProviderTestBase. That class will add tests for concurrent
access, and it will have one concrete subclass for each supported concurrent
access-friendly BEP. The other BEPs do not support concurrent access, so they
do not need those tests.</p>

<h2><a name="_Toc238450138">5.3<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>MemoryOnlyBackendProviderTestBase (abstract)</a></h2>

<p class=MsoNormal>The MemoryOnlyBackendProviderTestBase class is the main
workhorse base class for unit tests, since it uses an in-memory BEP. The
assumption is that all unit tests that need FDO will derive from this base
class, both in the FDO test suite, as well as external test classes.</p>

<p class=MsoNormal>An alternative to external clients using
MemoryOnlyBackendProviderTestBase is that we create mock FDO domain objects
that have no BEP at all. Such a mock FDO framework would also not need the UOW
support. It would just be barebones implementations of the domain model
interfaces. The justification for doing this is that those external clients
ought not be testing FDO, but their own code.</p>

<p class=MsoNormal>Those who do use MemoryOnlyBackendProviderTestBase can
expect to have a fully populated MDC, which has information on all of the
model-defined classes in FDO, as well as all model-defined properties and
dev-defined “virtual” properties. The MDC is populated with this information by
reflecting over the FDO assembly and adding the metadata to the cache, based on
some new subclasses of the .Net Attribute class. Two of these custom attribute
classes support the model-defined classes and properties (ModelClassAttribute
and ModelPropertyAttribute). The third (VirtualPropertyAttribute) supports
dev-defined virtual properties.</p>

<p class=MsoNormal>All BEPs that are created from scratch (rather than
restarted) are populated with some basic objects, among which are one
LangProject and a few writing systems, among other basic objects. One can see
the various objects created by looking at the FDOBackendProvider::BootstrapNewSystem()
method and the methods it calls.</p>

<p class=MsoNormal>There is one important extant subclass of
MemoryOnlyBackendProviderTestBase, which is ScrInMemoryFdoTestBase. It is
important because it serves as a sample of a class that adds lots of methods
used to support testing some sub-domain of FDO, in this case Scripture tests.
Other classes can be created to do similar things for other areas, such as the
lexicon, interlinear texts, Data Notebook, etc.</p>

<h1><a name="_Toc238450139">6<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Starting Flex-The window Frame</a></h1>

<p class=MsoNormal>Until such time as a regular mechanism is provided to start
Flex, you will need to use a command line option (shortcut or VS startup). It
will be like this: -db Memory</p>

<p class=MsoNormal>Currently supported options are:</p>

<p class=MsoListParagraphCxSpFirst style='text-indent:-.25in'>1.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Firebird,</p>

<p class=MsoListParagraphCxSpMiddle style='text-indent:-.25in'>2.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>DB4o,</p>

<p class=MsoListParagraphCxSpMiddle style='text-indent:-.25in'>3.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>BerkeleyDB,</p>

<p class=MsoListParagraphCxSpMiddle style='text-indent:-.25in'>4.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>XML,
and</p>

<p class=MsoListParagraphCxSpLast style='text-indent:-.25in'>5.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Memory</p>

<p class=MsoNormal>Flex does have a working File-Open menu, which uses the
simple .Net File-open dialog window. That dialog window is fed the supported
file extensions, so we can open a data store on any supported, persisted, BEP.</p>

</div>

<div><br clear=all>

<hr align=left size=1 width="33%">

<div id=ftn1>

<p class=MsoFootnoteText><a href="#_ftnref1" name="_ftn1" title=""><span
class=MsoFootnoteReference><span class=MsoFootnoteReference><span
style='font-size:10.0pt;line-height:115%;font-family:"Calibri","sans-serif"'>[1]</span></span></span></a>
I (RandyR) expect this document to not be exhaustively complete, but that it
will require updating as questions come up.</p>

</div>

</div>

<div>

<hr class=msocomoff align=left size=1 width="33%">

<div>

<div id="_com_1" class=msocomtxt language=JavaScript
onmouseover="msoCommentShow('_anchor_1','_com_1')"
onmouseout="msoCommentHide('_com_1')"><a name="_msocom_1"></a>

<p class=MsoCommentText><span class=MsoCommentReference><span style='font-size:
8.0pt'>&nbsp;<a href="#_msoanchor_1" class=msocomoff>[RBR1]</a></span></span>A
better clue would what are Domain Expert thinks are natural properties, and thus
a normal part of the Ubiquitous Language that is to be modeled in the code. It
really is not a matter of if Devs can think up a cool name.</p>

</div>

</div>

<div>

<div id="_com_2" class=msocomtxt language=JavaScript
onmouseover="msoCommentShow('_anchor_2','_com_2')"
onmouseout="msoCommentHide('_com_2')"><a name="_msocom_2"></a>

<p class=MsoCommentText><span class=MsoCommentReference><span style='font-size:
8.0pt'>&nbsp;<a href="#_msoanchor_2" class=msocomoff>[RBR2]</a></span></span>I
added stuff to the previous paragraph to answer the ‘IsRealObject’ part of your
question (must be removed).</p>

<p class=MsoCommentText>&nbsp;</p>

<p class=MsoCommentText>There ought not be any reason for “IsValidObject”
either, since objects cannot be in an invalid state by the end of a UOW,
according to the DDD rules. (Indeed, some DDD fans don’t even allow objects to
be invalid at any time, even during a UOW, but I thik that is a bit much to
expect.)</p>

</div>

</div>

<div>

<div id="_com_3" class=msocomtxt language=JavaScript
onmouseover="msoCommentShow('_anchor_3','_com_3')"
onmouseout="msoCommentHide('_com_3')"><a name="_msocom_3"></a>

<p class=MsoCommentText><span class=MsoCommentReference><span style='font-size:
8.0pt'>&nbsp;<a href="#_msoanchor_3" class=msocomoff>[JVT3]</a></span></span>Do
we hope, then, to guarantee that no client object ever retains a reference to
an FDO object that has been deleted, once the UOW that deleted it is over? If
so, how? Otherwise, what precaution should a client take in the new world to
make sure it is not trying to manipulate a deleted object?</p>

<p class=MsoCommentText>Also, if IsValidObject is also obsolete, we should note
that.</p>

</div>

</div>

<div>

<div id="_com_4" class=msocomtxt language=JavaScript
onmouseover="msoCommentShow('_anchor_4','_com_4')"
onmouseout="msoCommentHide('_com_4')"><a name="_msocom_4"></a>

<p class=MsoCommentText><span class=MsoCommentReference><span style='font-size:
8.0pt'>&nbsp;<a href="#_msoanchor_4" class=msocomoff>[RBR4]</a></span></span>We
cannot prevent clients from holding references to deleted objects. The best we
can do is make it painful to do so.</p>

<p class=MsoCommentText>&nbsp;</p>

<p class=MsoCommentText>We can add support to CmObjects that throws an
exception when clients try to use a deleted object. That would work for both
reads and writes.</p>

<p class=MsoCommentText>&nbsp;</p>

<p class=MsoCommentText>If we only wanted to prevent writes on deleted objects,
we need do nothing, as a deleted object has its FdoCache member nulled out. Any
attempt to register a modification will fail with a null ref exception being
thrown.</p>

<p class=MsoCommentText>&nbsp;</p>

<p class=MsoCommentText>Neither ‘IsRealObject’ nor ‘IsValidObject’ feel right
if a client wants to know if an object has been deleted. The ‘easiest thing’
for them to do is ask for the Hvo of the object. Deleted CmObject’s all share
the same hvo of “SpecialHVOValues.kHvoObjectDeleted” (-2). Likewise, clients
can check the hvo of an uninitialized CmObject, which is
“SpecialHVOValues.kHvoUninitializedObject” (-1)</p>

</div>

</div>

<div>

<div id="_com_5" class=msocomtxt language=JavaScript
onmouseover="msoCommentShow('_anchor_5','_com_5')"
onmouseout="msoCommentHide('_com_5')"><a name="_msocom_5"></a>

<p class=MsoCommentText><span class=MsoCommentReference><span style='font-size:
8.0pt'>&nbsp;<a href="#_msoanchor_5" class=msocomoff>[RBR5]</a></span></span>Until
I added support to ‘port’ form one BEP to another, there was always a base set
of data. Cf. the BootstrapNewSystem method on the FDOBackendProvider base class
for what is included in teach system.)</p>

<p class=MsoCommentText>&nbsp;</p>

<p class=MsoCommentText>It is quite possible now for there to be a special xml
file with the required test data in it that is loaded into the memory only BEP
for testing purposes. There will need to be a tweak or two to let it happen,
such as fetching the source file from the test class, but it is very possible
to do.</p>

</div>

</div>

<div>

<div id="_com_6" class=msocomtxt language=JavaScript
onmouseover="msoCommentShow('_anchor_6','_com_6')"
onmouseout="msoCommentHide('_com_6')"><a name="_msocom_6"></a>

<p class=MsoCommentText><span class=MsoCommentReference><span style='font-size:
8.0pt'>&nbsp;<a href="#_msoanchor_6" class=msocomoff>[JVT6]</a></span></span>Seems
as if we should decide some absolute minimum that is always present in the
“pristine state.” Then, there might actually be a number of alternate states
offering additional test data that is useful to multiple tests. Things will be
more robust if there isn’t just one such set, and many tests will have less to
load.</p>

<p class=MsoCommentText>The book I just read says no unit test should ever read
a file. Maybe the XML needed to set up such test cases could actually be
embedded in the code?</p>

<p class=MsoCommentText>There are performance issues here; if we’re going to
test with real FDO objects rather than stubs, we need to be able to get things
set up very fast.</p>

</div>

</div>

<div>

<div id="_com_7" class=msocomtxt language=JavaScript
onmouseover="msoCommentShow('_anchor_7','_com_7')"
onmouseout="msoCommentHide('_com_7')"><a name="_msocom_7"></a>

<p class=MsoCommentText><span class=MsoCommentReference><span style='font-size:
8.0pt'>&nbsp;<a href="#_msoanchor_7" class=msocomoff>[RBR7]</a></span></span>Bottom
line for me is that I never felt it my decision to sort out the bootstrap basic
version. It kind of is done already in the new LP template file, no?</p>

<p class=MsoCommentText>&nbsp;</p>

<p class=MsoCommentText>I do have a basic set of objects created for any BEP,
but I make no claims it is the definitive answer by any means.</p>

<p class=MsoCommentText>&nbsp;</p>

<p class=MsoCommentText>There is no current support for feeding a simple xml
string in to start a BEP, but it could be done. I would suggest using the XML
BEP to read the xml, but then ‘port’ it to the memory BEP for the tests.</p>

</div>

</div>

<div>

<div id="_com_8" class=msocomtxt language=JavaScript
onmouseover="msoCommentShow('_anchor_8','_com_8')"
onmouseout="msoCommentHide('_com_8')"><a name="_msocom_8"></a>

<p class=MsoCommentText><span class=MsoCommentReference><span style='font-size:
8.0pt'>&nbsp;<a href="#_msoanchor_8" class=msocomoff>[RBR8]</a></span></span>Actually,
one can check the HVO. Deleted and uninitialized objects will have negative
HVOs, while all ‘living’ CmObjects have a positive HVO. No CmObjects have an
HVO of zero (0) in any state.</p>

</div>

</div>

</div>

</body>

</html>
